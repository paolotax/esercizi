#!/bin/bash
# Script per abilitare SSL dopo la propagazione DNS

echo "üîç Verifico propagazione DNS..."

DNS_IP=$(getent hosts paolotax.it 2>/dev/null | awk '{print $1}')

if [ "$DNS_IP" = "46.224.19.243" ]; then
    echo "‚úÖ DNS propagato correttamente!"
    echo ""
    echo "Ora abilito SSL e cambio host nel config/deploy.yml..."
    
    # Riabilita SSL e cambia host da IP a dominio
    sed -i 's/ssl: false/ssl: true/' config/deploy.yml
    sed -i 's/host: 46.224.19.243/host: paolotax.it/' config/deploy.yml
    sed -i '/# SSL temporaneamente disabilitato/d' config/deploy.yml
    sed -i '/# Quando il DNS sar√† pronto/d' config/deploy.yml
    
    echo "‚úÖ SSL abilitato nel config!"
    echo ""
    echo "Ora eseguo il deploy per applicare le modifiche..."
    echo ""
    
    bin/kamal deploy
    
    echo ""
    echo "üéâ Fatto! L'app ora √® accessibile via HTTPS su:"
    echo "   https://paolotax.it"
else
    echo "‚ùå DNS non ancora propagato."
    echo "   Attuale IP: ${DNS_IP:-non risolve}"
    echo "   IP atteso: 46.224.19.243"
    echo ""
    echo "Controlla la propagazione su: https://www.whatsmydns.net/#A/paolotax.it"
    echo ""
    echo "Riprova tra qualche minuto/ora quando il DNS sar√† propagato."
    exit 1
fi

