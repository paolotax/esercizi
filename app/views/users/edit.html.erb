<% @page_title = "Modifica profilo" %>

<div class="min-h-screen flex items-start justify-center bg-cream dark:bg-gray-900 pt-16 pb-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-md w-full space-y-6 bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl shadow-gray-900/10 p-8 md:p-10 text-center relative fade-in-up card-lift">
    <%= link_to user_path(@user),
          data: { controller: "hotkey", action: "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" },
          class: "absolute top-4 left-4 p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" do %>
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      <span class="sr-only">Torna al profilo</span>
    <% end %>

    <%= form_with model: @user, method: :patch, class: "space-y-6", data: { controller: "form upload-preview" } do |form| %>
      <div class="flex flex-col items-center gap-4">
        <label class="relative cursor-pointer group">
          <div class="w-24 h-24 rounded-full bg-white dark:bg-gray-700 shadow-lg overflow-hidden ring-4 ring-coral/30 dark:ring-coral/20 group-hover:ring-coral/50 transition-all">
            <%= image_tag user_avatar_path(@user), alt: "Avatar", class: "w-full h-full object-cover", data: { upload_preview_target: "image" } %>
          </div>
          <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <%= form.file_field :avatar, class: "sr-only", accept: "image/jpeg,image/png,image/gif,image/webp",
                data: { upload_preview_target: "input", action: "upload-preview#previewImage" } %>
        </label>

        <% if @user.avatar.attached? %>
          <%= tag.button type: :submit, form: "avatar-delete-form",
                class: "inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 rounded-lg transition-colors",
                data: { turbo_confirm: "Sei sicuro di voler rimuovere il tuo avatar? Non potrai annullare questa azione." } do %>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
            </svg>
            <span class="sr-only">Elimina avatar</span>
          <% end %>
        <% end %>
      </div>

      <div class="space-y-4">
        <div>
          <label for="user_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-left mb-1">Nome</label>
          <%= form.text_field :name,
                class: "w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-coral focus:border-transparent transition-all",
                autocomplete: "name",
                placeholder: "Il tuo nome",
                autofocus: true,
                required: true,
                data: { "1p-ignore": true, action: "keydown.esc->form#cancel" } %>
        </div>

        <div>
          <label for="user_email_address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-left mb-1">Email</label>
          <div class="flex items-center gap-2">
            <%= form.email_field :email_address,
                  class: "flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed",
                  autocomplete: "username",
                  readonly: true,
                  value: @user.identity.email_address %>
            <a href="<%= new_user_email_address_path(user_id: @user.id) %>" class="text-sm text-coral dark:text-coral hover:text-coral-dark whitespace-nowrap">
              Cambia
            </a>
          </div>
        </div>
      </div>

      <% if @user.errors.any? %>
        <div class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-left">
          <p class="text-sm font-medium text-red-800 dark:text-red-200">Le modifiche non possono essere salvate:</p>
          <ul class="mt-2 text-sm text-red-700 dark:text-red-300 list-disc list-inside">
            <% @user.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="flex flex-col gap-3 pt-4">
        <button type="submit" class="w-full px-6 py-3 bg-coral hover:bg-coral-dark text-white font-semibold rounded-xl transition-colors btn-press" data-form-target="submit">
          Salva modifiche
        </button>

        <%= link_to "Annulla", user_path(@user),
              class: "text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors",
              data: { form_target: "cancel" } %>
      </div>
    <% end %>

    <%= form_with url: user_avatar_url(@user), method: :delete, id: "avatar-delete-form" %>
  </div>
</div>
