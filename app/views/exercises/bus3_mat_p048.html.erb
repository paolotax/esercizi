<% content_for :titolo, "#{@pagina.titolo} - #{@pagina.numero}" %>

<div class="max-w-7xl mx-auto p-3 md:p-6 bg-white dark:bg-gray-900 text-black dark:text-white transition-colors duration-300" data-controller="exercise-checker page-viewer text-toggle font-controls" data-page-viewer-image-url-value="<%= asset_path('bus3_mat/p048/page.png') %>" data-text-toggle-target="content" data-font-controls-target="content">
  <!-- Header -->
  <%= render 'shared/page_header', pagina: @pagina %>

  <!-- Parte teorica: Moltiplicazioni con due cifre -->
  <div class="bg-[#C7EAFB] dark:bg-cyan-900/40 p-4 md:p-6 -ml-3 md:-ml-0 -mr-3 md:mr-0 mb-8">
    <p class="text-gray-800 dark:text-gray-200 mb-6">
      <strong class="text-red-500">•</strong> Osserva e leggi come si eseguono le moltiplicazioni con due cifre al moltiplicatore.
    </p>

    <ul class="list-none ml-4 mb-6 space-y-2 text-gray-800 dark:text-gray-200">
      <li><span class="text-red-500 font-bold">•</span> Prima moltiplichi le <span class="text-cyan-500 font-bold">unità</span> del moltiplicatore e trovi il <span class="font-bold">primo prodotto parziale</span>.</li>
      <li><span class="text-red-500 font-bold">•</span> Poi moltiplichi le <span class="text-red-500 font-bold">decine</span> del moltiplicatore e trovi il <span class="font-bold">secondo prodotto parziale</span>.</li>
      <li><span class="text-red-500 font-bold">•</span> Infine sommi i due prodotti parziali.</li>
    </ul>

    <!-- Immagini esempi affiancate -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <div class="flex flex-col items-start gap-2">
        <%= image_tag "bus3_mat/p048/p48_1.jpg",
            alt: "Primo prodotto parziale",
            class: "max-w-full ml-8 dark:bg-white dark:rounded-lg dark:p-2" %>
        <p class="text-gray-700 dark:text-gray-200 text-left">
          <span class="text-red-500 font-bold">•</span> Il <span class="font-bold">primo prodotto parziale</span>
          si scrive iniziando dalla colonna
          delle <span class="text-cyan-500 font-bold">unità</span>.<br>
          Fai attenzione ai cambi.
        </p>
      </div>

      <div class="flex flex-col items-start gap-2">
        <%= image_tag "bus3_mat/p048/p48_2.jpg",
            alt: "Secondo prodotto parziale",
            class: "max-w-full ml-8 dark:bg-white dark:rounded-lg dark:p-2" %>
        <p class="text-gray-700 dark:text-gray-200 text-left">
          <span class="text-red-500 font-bold">•</span> Il <span class="font-bold">secondo prodotto parziale</span> si scrive iniziando
          dalla colonna delle <span class="text-red-500 font-bold">decine</span>, quindi si mette uno
          <span class="text-cyan-500 font-bold">0</span> segnaposto nella colonna delle <span class="text-cyan-500 font-bold">unità</span>. Poi si
          sommano i prodotti parziali: ecco il <span class="font-bold">prodotto finale</span>.
        </p>
      </div>
    </div>
  </div>

  <!-- Esercizio 1: Calcola in colonna -->
  <div class="p-4 md:p-8 mb-8" data-controller="operation-viewer">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
        1
      </div>
      <p class="text-gray-700 dark:text-gray-200">
        Calcola in colonna sul quaderno.
      </p>
    </div>

    <%
      es1_gruppi = [
        { lettera: "a", colore: "orange", operazioni: [
          { op: "36x12", answer: "432" },
          { op: "37x14", answer: "518" },
          { op: "42x20", answer: "840" },
          { op: "19x27", answer: "513" },
          { op: "25x16", answer: "400" },
          { op: "58x35", answer: "2030" }
        ]},
        { lettera: "b", colore: "blue", operazioni: [
          { op: "60x21", answer: "1260" },
          { op: "38x24", answer: "912" },
          { op: "52x19", answer: "988" },
          { op: "23x45", answer: "1035" },
          { op: "65x47", answer: "3055" },
          { op: "25x38", answer: "950" }
        ]},
        { lettera: "c", colore: "green", operazioni: [
          { op: "216x34", answer: "7344" },
          { op: "205x28", answer: "5740" },
          { op: "118x26", answer: "3068" },
          { op: "49x19", answer: "931" },
          { op: "136x38", answer: "5168" },
          { op: "155x41", answer: "6355" }
        ]},
        { lettera: "d", colore: "purple", operazioni: [
          { op: "204x28", answer: "5712" },
          { op: "444x13", answer: "5772" },
          { op: "205x36", answer: "7380" },
          { op: "148x55", answer: "8140" },
          { op: "403x24", answer: "9672" },
          { op: "299x27", answer: "8073" }
        ]}
      ]
    %>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 items-start">
      <% es1_gruppi.each do |gruppo| %>
        <%
          operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
            { operation: item[:op], targetId: "es1-#{gruppo[:lettera]}-#{idx}" }
          }
        %>
        <div class="bg-<%= gruppo[:colore] %>-50 dark:bg-<%= gruppo[:colore] %>-900/30 p-4 rounded-lg border-2 border-transparent hover:border-<%= gruppo[:colore] %>-400 transition">
          <p class="font-bold text-<%= gruppo[:colore] %>-600 dark:text-<%= gruppo[:colore] %>-400 mb-3 flex items-center gap-2">
            <%= gruppo[:lettera] %>.
            <button type="button"
                    data-action="click->operation-viewer#openGroup"
                    data-operations='<%= operations_data.to_json %>'
                    data-type="moltiplicazione"
                    data-layout="column"
                    data-display="modal"
                    data-group="<%= gruppo[:lettera] %>"
                    class="p-1 text-gray-400 hover:text-<%= gruppo[:colore] %>-600 dark:hover:text-<%= gruppo[:colore] %>-400 transition print-hidden"
                    title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
            </button>
          </p>
          <ul class="space-y-2">
            <% gruppo[:operazioni].each_with_index do |item, idx| %>
              <li class="flex items-center gap-2 flex-wrap dark:text-white">
                <span><%= item[:op].gsub('x', ' × ') %> =</span>
                <input type="text"
                       data-operation-id="es1-<%= gruppo[:lettera] %>-<%= idx %>"
                       data-correct-answer="<%= item[:answer] %>"
                       class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent">
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

    <div class="mt-6 text-right">
      <span class="text-gray-600 dark:text-gray-400">Quaderno →</span> <%= link_to "p. 151", pagina_path("bus3_mat_p151"), class: "text-cyan-600 dark:text-cyan-400 font-bold hover:underline" %>
    </div>

    <!-- Modal -->
    <%= render 'shared/operation_viewer', display: :modal, title: "Moltiplicazioni in colonna", color: "green" %>
  </div>

  <!-- Footer con controlli -->
  <%= render 'shared/exercise_controls' %>
</div>
