<div class="max-w-6xl mx-auto bg-white dark:bg-gray-900 p-3 md:p-6 transition-colors duration-300"
     data-controller="exercise-checker text-toggle font-controls"
     data-text-toggle-target="content"
     data-font-controls-target="content">

  <%= render 'shared/page_header', pagina: @pagina %>

  <div class="space-y-6">

    <!-- Box teoria: Proprietà invariantiva -->
    <div class="p-4 bg-cyan-50 dark:bg-cyan-900 rounded-lg border-2 border-cyan-400 dark:border-cyan-600">
      <p class="font-bold text-cyan-600 dark:text-cyan-400 mb-3">Proprietà invariantiva</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Esempio 1: sottrai lo stesso numero -->
        <div class="flex flex-col items-center gap-1">
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">62</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="text-gray-700 dark:text-gray-200">13</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <span class="text-gray-700 dark:text-gray-200">49</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-cyan-500 font-bold">↓ – 2</span>
            <span class="invisible">–</span>
            <span class="text-cyan-500 font-bold">↓ – 2</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold text-gray-700 dark:text-gray-200">60</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="font-bold text-gray-700 dark:text-gray-200">11</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <span class="text-gray-700 dark:text-gray-200">49</span>
          </div>
        </div>
        <!-- Esempio 2: aggiungi lo stesso numero -->
        <div class="flex flex-col items-center gap-1">
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">62</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="text-gray-700 dark:text-gray-200">13</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <span class="text-gray-700 dark:text-gray-200">49</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-cyan-500 font-bold">↓ + 7</span>
            <span class="invisible">–</span>
            <span class="text-cyan-500 font-bold">↓ + 7</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold text-gray-700 dark:text-gray-200">69</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="font-bold text-gray-700 dark:text-gray-200">20</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <span class="text-gray-700 dark:text-gray-200">49</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Esercizio 1: IMPARARE TUTTI - Calcola applicando la proprietà invariantiva -->
    <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl border-3 border-yellow-400 dark:border-yellow-500">
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= imparare_tutti_badge(1) %>
        Calcola applicando la proprietà invariantiva.
      </p>

      <!-- Prima riga: 68-31, 163-43, 198-58 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- 68 - 31 = 37 (esempio, -1) -->
        <div class="flex flex-col items-center gap-1">
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">68</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="text-gray-700 dark:text-gray-200">31</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <span class="font-bold text-cyan-600 dark:text-cyan-400">37</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-cyan-500 font-bold">↓ – 1</span>
            <span class="invisible">–</span>
            <span class="text-cyan-500 font-bold">↓ – 1</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold text-cyan-600 dark:text-cyan-400">67</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="font-bold text-cyan-600 dark:text-cyan-400">30</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <span class="font-bold text-cyan-600 dark:text-cyan-400">37</span>
          </div>
        </div>

        <!-- 163 - 43 = 120 (+7) -->
        <div class="flex flex-col items-center gap-1">
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">163</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="text-gray-700 dark:text-gray-200">43</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="120" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
          <div class="flex items-center gap-2">
            <span class="text-cyan-500 font-bold">↓ + 7</span>
            <span class="invisible">–</span>
            <span class="text-cyan-500 font-bold">↓ + 7</span>
          </div>
          <div class="flex items-center gap-2">
            <input type="text" data-correct-answer="170" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <input type="text" data-correct-answer="50" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="120" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
        </div>

        <!-- 198 - 58 = 140 (+2) -->
        <div class="flex flex-col items-center gap-1">
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">198</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="text-gray-700 dark:text-gray-200">58</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="140" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
          <div class="flex items-center gap-2">
            <span class="text-cyan-500 font-bold">↓ + 2</span>
            <span class="invisible">–</span>
            <span class="text-cyan-500 font-bold">↓ + 2</span>
          </div>
          <div class="flex items-center gap-2">
            <input type="text" data-correct-answer="200" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <input type="text" data-correct-answer="60" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="140" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
        </div>
      </div>

      <!-- Seconda riga: 654-629, 515-205, 829-419 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- 654 - 629 = 25 (+1) -->
        <div class="flex flex-col items-center gap-1">
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">654</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="text-gray-700 dark:text-gray-200">629</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="25" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
          <div class="flex items-center gap-2">
            <span class="text-cyan-500 font-bold">↓ + 1</span>
            <span class="invisible">–</span>
            <span class="text-gray-700 dark:text-gray-200">↓</span>
            <input type="text" data-correct-answer="+1" class="w-10 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
          <div class="flex items-center gap-2">
            <input type="text" data-correct-answer="655" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <input type="text" data-correct-answer="630" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="25" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
        </div>

        <!-- 515 - 205 = 310 (+5) -->
        <div class="flex flex-col items-center gap-1">
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">515</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="text-gray-700 dark:text-gray-200">205</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="310" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">↓</span>
            <input type="text" data-correct-answer="-5" class="w-10 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="invisible">–</span>
            <span class="text-gray-700 dark:text-gray-200">↓</span>
            <input type="text" data-correct-answer="-5" class="w-10 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
          <div class="flex items-center gap-2">
            <input type="text" data-correct-answer="510" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <input type="text" data-correct-answer="200" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="310" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
        </div>

        <!-- 829 - 419 = 410 (+1) -->
        <div class="flex flex-col items-center gap-1">
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">829</span>
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <span class="text-gray-700 dark:text-gray-200">419</span>
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="410" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-700 dark:text-gray-200">↓</span>
            <input type="text" data-correct-answer="+1" class="w-10 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="invisible">–</span>
            <span class="text-gray-700 dark:text-gray-200">↓</span>
            <input type="text" data-correct-answer="+1" class="w-10 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
          <div class="flex items-center gap-2">
            <input type="text" data-correct-answer="830" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">–</span>
            <input type="text" data-correct-answer="420" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="410" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
        </div>
      </div>
    </div>

    <!-- Esercizio 2: Calcola in riga applicando la proprietà invariantiva -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(2) %>
        Calcola in riga applicando la proprietà invariantiva per semplificare i calcoli. Segui l'esempio.
      </p>

      <div class="space-y-4">
        <!-- Esempio -->
        <div class="p-3 bg-cyan-50 dark:bg-cyan-900 rounded-lg">
          <p class="font-bold text-gray-700 dark:text-gray-200">
            731 – 121 = (<span class="text-cyan-600 dark:text-cyan-400">731 – 21</span>) – (<span class="text-cyan-600 dark:text-cyan-400">121 – 21</span>) = <span class="text-cyan-600 dark:text-cyan-400">710 – 100</span> = <span class="text-cyan-600 dark:text-cyan-400">610</span>
          </p>
        </div>

        <!-- Note -->
        <div class="p-3 bg-pink-light dark:bg-pink-900/40 rounded-xl w-fit">
          <p class="text-gray-600 dark:text-gray-300">Puoi applicare la proprietà invariantiva anche utilizzando le parentesi.</p>
        </div>

        <!-- Esercizi -->
        <div class="space-y-3">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-gray-700 dark:text-gray-200">475 – 315 = (</span>
            <input type="text" data-correct-answer="475-15" class="w-20 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">) – (</span>
            <input type="text" data-correct-answer="315-15" class="w-20 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">) =</span>
            <input type="text" data-correct-answer="460-300" class="w-24 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="160" class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>

          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-gray-700 dark:text-gray-200">7 916 – 803 = (</span>
            <input type="text" data-correct-answer="7916-3" class="w-20 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">) – (</span>
            <input type="text" data-correct-answer="803-3" class="w-20 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">) =</span>
            <input type="text" data-correct-answer="7913-800" class="w-24 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="7113" class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>

          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-gray-700 dark:text-gray-200">1 947 – 207 = (</span>
            <input type="text" data-correct-answer="1947-7" class="w-20 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">) – (</span>
            <input type="text" data-correct-answer="207-7" class="w-20 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">) =</span>
            <input type="text" data-correct-answer="1940-200" class="w-24 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">=</span>
            <input type="text" data-correct-answer="1740" class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
        </div>
      </div>
    </div>

    <!-- Esercizio 3: Correggi gli errori -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(3) %>
        In queste sottrazioni <span class="italic">non</span> è stata applicata correttamente la proprietà invariantiva. Correggi gli errori e calcola. Segui l'esempio.
      </p>

      <div class="space-y-4">
        <!-- Esempio -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="text-gray-700 dark:text-gray-200 line-through">735 – 25 = (735 + 5) – (25 – 5)</div>
          <div class="font-bold text-cyan-600 dark:text-cyan-400">(735 – 5) – (25 – 5) = 730 – 20 = 710</div>
        </div>

        <% [
          { wrong: "479 – 157 = (479 + 3) – (157 – 7)", correct: "(479+3)-(157+3)=482-160=322" },
          { wrong: "864 – 544 = (864 + 6) – (544 + 16)", correct: "(864+6)-(544+6)=870-550=320" },
          { wrong: "9 414 – 314 = (9 414 – 14) – (314 + 14)", correct: "(9414-14)-(314-14)=9400-300=9100" }
        ].each do |item| %>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="text-gray-700 dark:text-gray-200"><%= item[:wrong] %></div>
            <input type="text" data-correct-answer="<%= item[:correct] %>" class="min-w-0 flex-1 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
        <% end %>
      </div>
    </div>

    <!-- Esercizio 4: Scrivi quale numero è stato aggiunto o tolto -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(4) %>
        Scrivi quale numero è stato aggiunto o tolto nella prima sottrazione per ottenere la seconda. Segui l'esempio.
      </p>

      <div class="space-y-3">
        <!-- Esempio -->
        <div class="flex items-center gap-4 flex-wrap">
          <span class="font-bold text-gray-700 dark:text-gray-200">80 – 27 = 83 – 30</span>
          <span class="font-bold text-cyan-600 dark:text-cyan-400">+ 3</span>
        </div>

        <% [
          { op: "486 – 121 = 485 – 120", answer: "-1" },
          { op: "658 – 125 = 653 – 120", answer: "-5" },
          { op: "740 – 29 = 741 – 30", answer: "+1" },
          { op: "879 – 136 = 873 – 130", answer: "-6" },
          { op: "1 597 – 47 = 1 600 – 50", answer: "+3" }
        ].each do |item| %>
          <div class="flex items-center gap-4 flex-wrap">
            <span class="text-gray-700 dark:text-gray-200"><%= item[:op] %></span>
            <input type="text" data-correct-answer="<%= item[:answer] %>" class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
        <% end %>
      </div>
    </div>

    <%= render 'shared/exercise_controls' %>
  </div>
</div>
