<div class="max-w-6xl mx-auto bg-white dark:bg-gray-900 p-3 md:p-6 transition-colors duration-300"
     data-controller="exercise-checker text-toggle font-controls operation-viewer"
     data-text-toggle-target="content"
     data-font-controls-target="content">

  <%= render 'shared/page_header', pagina: @pagina %>

  <div class="space-y-6">

    <!-- Esercizio 1: IMPARARE TUTTI - Calcola in riga -->
    <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl border-3 border-yellow-400 dark:border-yellow-500">
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= imparare_tutti_badge(1) %>
        Calcola in riga. Segui l'esempio.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <div class="p-3 bg-cyan-50 dark:bg-cyan-900 rounded-lg mb-4">
            <p class="text-gray-600 dark:text-gray-300">Somma <span class="font-bold">u</span> con <span class="font-bold">u</span>,<br><span class="font-bold">da</span> con <span class="font-bold">da</span>,<br><span class="font-bold">h</span> con <span class="font-bold">h</span>...</p>
          </div>
          <!-- Esempio con immagine -->
          <div class="mb-4">
            <%= image_tag "nvi4_mat/p179/p179_01.jpg", class: "max-w-full h-auto dark:bg-white dark:rounded-lg dark:p-1", alt: "Esempio: 25 + 32 = 57" %>
          </div>
        </div>

        <div>
          <%= render 'shared/fill_list',
              color: "cyan",
              equals: true,
              container_class: "space-y-3",
              items: [
                { prefix: "53 + 46", answer: "99", width: "w-20" },
                { prefix: "254 + 343", answer: "597", width: "w-20" },
                { prefix: "1 350 + 3 126", answer: "4476", width: "w-20" }
              ] %>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
        <div>
          <%= render 'shared/fill_list',
              color: "cyan",
              equals: true,
              container_class: "space-y-3",
              items: [
                { prefix: "37 + 62", answer: "99", width: "w-20" },
                { prefix: "136 + 252", answer: "388", width: "w-20" },
                { prefix: "326 + 513", answer: "839", width: "w-20" },
                { prefix: "3 571 + 128", answer: "3699", width: "w-20" }
              ] %>
        </div>
        <div>
          <%= render 'shared/fill_list',
              color: "cyan",
              equals: true,
              container_class: "space-y-3",
              items: [
                { prefix: "47 + 33", answer: "80", width: "w-20" },
                { prefix: "169 + 11", answer: "180", width: "w-20" },
                { prefix: "425 + 14", answer: "439", width: "w-20" },
                { prefix: "2 133 + 3 211", answer: "5344", width: "w-20" }
              ] %>
        </div>
      </div>
    </div>

    <!-- Esercizio 2: Addizioni in colonna con sidebar -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(2) %>
        Esegui le addizioni in colonna e trascrivi i risultati.
      </p>

      <%
        es2_gruppi = [
          { lettera: "a", operazioni: [
            { op: "906+3524", answer: "4430" },
            { op: "3652+8574", answer: "12226" }
          ]},
          { lettera: "b", operazioni: [
            { op: "4560+457", answer: "5017" },
            { op: "8297+125+703", answer: "9125" }
          ]},
          { lettera: "c", operazioni: [
            { op: "782+4625+1066", answer: "6473" },
            { op: "1430+789+5601", answer: "7820" }
          ]}
        ]
      %>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <% es2_gruppi.each do |gruppo| %>
          <%
            operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
              { operation: item[:op], targetId: "es2-#{gruppo[:lettera]}-#{idx}" }
            }
          %>
          <div class="p-3 bg-cyan-50 dark:bg-cyan-900/30 rounded-lg">
            <p class="text-gray-700 dark:text-gray-200 font-bold mb-2 flex items-center gap-2">
              <%= gruppo[:lettera] %>.
              <button type="button"
                      data-action="click->operation-viewer#openGroup"
                      data-operations='<%= operations_data.to_json %>'
                      data-type="addizione"
                      data-group="<%= gruppo[:lettera] %>"
                      class="p-1 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition print-hidden"
                      title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </button>
            </p>
            <ul class="space-y-2">
              <% gruppo[:operazioni].each_with_index do |item, idx| %>
                <li class="flex items-center gap-2 flex-wrap">
                  <span class="text-gray-700 dark:text-gray-200"><%= item[:op].gsub('+', ' + ') %> =</span>
                  <input type="text"
                         data-operation-id="es2-<%= gruppo[:lettera] %>-<%= idx %>"
                         data-correct-answer="<%= item[:answer] %>"
                         class="w-20 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Esercizio 3: Calcola in colonna sul quaderno -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(3) %>
        Calcola in colonna sul quaderno.
      </p>

      <%
        es3_gruppi = [
          { lettera: "a", operazioni: [
            { op: "38565+25380", answer: "63945" },
            { op: "4756+32580", answer: "37336" },
            { op: "25360+1321", answer: "26681" },
            { op: "2315+307640", answer: "309955" }
          ]},
          { lettera: "b", operazioni: [
            { op: "24720+39", answer: "24759" },
            { op: "54970+234", answer: "55204" },
            { op: "318725+456893", answer: "775618" },
            { op: "756432+35734", answer: "792166" }
          ]},
          { lettera: "c", operazioni: [
            { op: "795743+187964", answer: "983707" },
            { op: "1585+338976", answer: "340561" },
            { op: "387+753654", answer: "754041" },
            { op: "99243+325768", answer: "425011" }
          ]}
        ]
      %>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <% es3_gruppi.each do |gruppo| %>
          <%
            operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
              { operation: item[:op], targetId: "es3-#{gruppo[:lettera]}-#{idx}" }
            }
          %>
          <div class="p-3 bg-cyan-50 dark:bg-cyan-900/30 rounded-lg">
            <p class="text-gray-700 dark:text-gray-200 font-bold mb-2 flex items-center gap-2">
              <%= gruppo[:lettera] %>.
              <button type="button"
                      data-action="click->operation-viewer#openGroup"
                      data-operations='<%= operations_data.to_json %>'
                      data-type="addizione"
                      data-group="<%= gruppo[:lettera] %>"
                      class="p-1 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition print-hidden"
                      title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </button>
            </p>
            <ul class="space-y-2">
              <% gruppo[:operazioni].each_with_index do |item, idx| %>
                <li class="flex items-center gap-2 flex-wrap">
                  <span class="text-gray-700 dark:text-gray-200"><%= item[:op].gsub('+', ' + ') %> =</span>
                  <input type="text"
                         data-operation-id="es3-<%= gruppo[:lettera] %>-<%= idx %>"
                         data-correct-answer="<%= item[:answer] %>"
                         class="w-24 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Esercizio 4: Calcola e indica con X il risultato corretto -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(4) %>
        Calcola in colonna sul quaderno. Poi indica con una <span class="font-bold text-cyan-600 dark:text-cyan-400">X</span> il risultato corretto.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <% [
          { op: "25 672 + 934 + 1 278", options: ["28 874", "27 894", "27 884"], correct: "27 884" },
          { op: "69 085 + 888 + 321 202", options: ["391 175", "390 165", "391 715"], correct: "391 175" }
        ].each_with_index do |item, idx| %>
          <div class="space-y-2">
            <p class="text-gray-700 dark:text-gray-200"><span class="text-cyan-500">•</span> <%= item[:op] %> =</p>
            <div class="flex flex-wrap gap-2 ml-4">
              <% item[:options].each do |opt| %>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200">
                  <input type="checkbox" class="w-5 h-5" data-correct-answer="<%= opt == item[:correct] %>">
                  <span class="whitespace-nowrap"><%= opt %></span>
                </label>
              <% end %>
            </div>
          </div>
        <% end %>

        <% [
          { op: "46 701 + 223 071 + 649", options: ["271 411", "270 421", "270 241"], correct: "270 421" },
          { op: "13 728 + 504 + 127 099", options: ["141 342", "141 341", "141 331"], correct: "141 331" }
        ].each_with_index do |item, idx| %>
          <div class="space-y-2">
            <p class="text-gray-700 dark:text-gray-200"><span class="text-cyan-500">•</span> <%= item[:op] %> =</p>
            <div class="flex flex-wrap gap-2 ml-4">
              <% item[:options].each do |opt| %>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200">
                  <input type="checkbox" class="w-5 h-5" data-correct-answer="<%= opt == item[:correct] %>">
                  <span class="whitespace-nowrap"><%= opt %></span>
                </label>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <%= render 'shared/operation_viewer' %>
    <%= render 'shared/exercise_controls' %>
  </div>
</div>
