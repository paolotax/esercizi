<div class="max-w-6xl mx-auto bg-white dark:bg-gray-900 p-3 md:p-6 transition-colors duration-300"
     data-controller="exercise-checker text-toggle font-controls operation-viewer"
     data-text-toggle-target="content"
     data-font-controls-target="content">

  <%= render 'shared/page_header', pagina: @pagina %>

  <div class="space-y-6">

    <!-- Esercizio 1: Calcola in colonna e trascrivi i risultati -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(1) %>
        Calcola in colonna e trascrivi i risultati.
      </p>

      <%
        es1_gruppi = [
          { lettera: "a", descrizione: "Prendi due cifre", operazioni: [
            { op: "2291:19", answer: "120 resto 11" },
            { op: "2990:13", answer: "230" },
            { op: "6895:63", answer: "109 resto 28" }
          ]},
          { lettera: "b", descrizione: "Prendi tre cifre", operazioni: [
            { op: "1158:35", answer: "33 resto 3" },
            { op: "1239:25", answer: "49 resto 14" },
            { op: "2789:34", answer: "82 resto 1" }
          ]}
        ]
      %>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <% es1_gruppi.each do |gruppo| %>
          <%
            operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
              { operation: item[:op], targetId: "es1-#{gruppo[:lettera]}-#{idx}" }
            }
          %>
          <div class="p-3 bg-cyan-50 dark:bg-cyan-900/30 rounded-lg">
            <p class="text-gray-700 dark:text-gray-200 font-bold mb-2 flex items-center gap-2">
              <%= gruppo[:lettera] %>. <%= gruppo[:descrizione] %>
              <button type="button"
                      data-action="click->operation-viewer#openGroup"
                      data-operations='<%= operations_data.to_json %>'
                      data-type="divisione"
                      data-group="<%= gruppo[:lettera] %>"
                      class="p-1 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition print-hidden"
                      title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </button>
            </p>
            <ul class="space-y-2">
              <% gruppo[:operazioni].each_with_index do |item, idx| %>
                <li class="flex items-center gap-2 flex-wrap">
                  <span class="text-gray-700 dark:text-gray-200"><%= item[:op].gsub(':', ' : ') %> =</span>
                  <input type="text"
                         data-operation-id="es1-<%= gruppo[:lettera] %>-<%= idx %>"
                         data-correct-answer="<%= item[:answer] %>"
                         class="w-32 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>

      <!-- Immagine esplicativa -->
      <div class="mt-4 flex justify-center">
        <%= image_tag "nvi4_mat/p191/p191_01.jpg", class: "max-w-md h-auto dark:bg-white dark:rounded-lg dark:p-1", alt: "Esempio divisione" %>
      </div>
    </div>

    <!-- Esercizio 2: Calcola in colonna sul quaderno -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(2) %>
        Calcola in colonna sul quaderno e trascrivi i risultati. Poi fai la prova.
      </p>

      <%
        es2_gruppi = [
          { lettera: "a", operazioni: [
            { op: "3962:14", answer: "283" },
            { op: "8850:25", answer: "354" },
            { op: "1725:82", answer: "21 resto 3" },
            { op: "1768:34", answer: "52" }
          ]},
          { lettera: "b", operazioni: [
            { op: "14612:26", answer: "562" },
            { op: "22855:35", answer: "653" },
            { op: "89752:42", answer: "2137 resto 6" },
            { op: "13923:39", answer: "357" }
          ]}
        ]
      %>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <% es2_gruppi.each do |gruppo| %>
          <%
            operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
              { operation: item[:op], targetId: "es2-#{gruppo[:lettera]}-#{idx}" }
            }
          %>
          <div class="p-3 bg-cyan-50 dark:bg-cyan-900/30 rounded-lg">
            <p class="text-gray-700 dark:text-gray-200 font-bold mb-2 flex items-center gap-2">
              <%= gruppo[:lettera] %>.
              <button type="button"
                      data-action="click->operation-viewer#openGroup"
                      data-operations='<%= operations_data.to_json %>'
                      data-type="divisione"
                      data-group="<%= gruppo[:lettera] %>"
                      class="p-1 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition print-hidden"
                      title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </button>
            </p>
            <ul class="space-y-2">
              <% gruppo[:operazioni].each_with_index do |item, idx| %>
                <li class="flex items-center gap-2 flex-wrap">
                  <span class="text-gray-700 dark:text-gray-200"><%= item[:op].gsub(':', ' : ') %> =</span>
                  <input type="text"
                         data-operation-id="es2-<%= gruppo[:lettera] %>-<%= idx %>"
                         data-correct-answer="<%= item[:answer] %>"
                         class="w-32 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Esercizio 3: Trova la parola nascosta -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-2">
        <%= numero_esercizio_badge(3) %>
        Calcola e colora le lettere accanto alle divisioni con <span class="bg-cyan-100 dark:bg-cyan-800 px-1 rounded">resto 0</span>.
      </p>
      <p class="text-gray-700 dark:text-gray-200 mb-4">
        Quale parola appare? Scrivila nel riquadro in basso.
      </p>

      <div class="space-y-3">
        <% [
          { op: "1 143 : 9", q: "127", r: "0", letter: "A" },
          { op: "1 347 : 6", q: "224", r: "3", letter: "F" },
          { op: "3 048 : 12", q: "254", r: "0", letter: "M" },
          { op: "3 538 : 58", q: "61", r: "0", letter: "I" },
          { op: "7 564 : 23", q: "328", r: "20", letter: "A" },
          { op: "44 603 : 73", q: "611", r: "0", letter: "C" },
          { op: "64 578 : 62", q: "1041", r: "36", letter: "S" },
          { op: "59 943 : 87", q: "689", r: "0", letter: "I" }
        ].each do |item| %>
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-gray-700 dark:text-gray-200 w-36"><%= item[:op] %> =</span>
            <input type="text" data-correct-answer="<%= item[:q] %>" class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="text-gray-700 dark:text-gray-200">resto</span>
            <input type="text" data-correct-answer="<%= item[:r] %>" class="w-14 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            <span class="px-2 py-1 border-2 border-cyan-400 dark:border-cyan-600 rounded font-bold text-gray-700 dark:text-gray-200">[<%= item[:letter] %>]</span>
          </div>
        <% end %>
      </div>

      <!-- Parola finale -->
      <div class="mt-6 flex items-center gap-2">
        <span class="font-bold text-gray-700 dark:text-gray-200">Parola:</span>
        <input type="text" data-correct-answer="AMICI" class="w-32 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
      </div>
    </div>

    <%= render 'shared/operation_viewer' %>
    <%= render 'shared/exercise_controls' %>
  </div>
</div>
