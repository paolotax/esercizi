<div class="max-w-6xl mx-auto bg-white dark:bg-gray-900 p-3 md:p-6 transition-colors duration-300"
     data-controller="exercise-checker text-toggle font-controls quaderno-sidebar"
     data-text-toggle-target="content"
     data-font-controls-target="content">

  <%= render 'shared/page_header', pagina: @pagina %>

  <div class="space-y-6">

    <!-- Esercizio 1 IMPARARE TUTTI + Regola -->
    <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl border-3 border-yellow-400 dark:border-yellow-500">
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= imparare_tutti_badge(1) %>
        Metti la virgola nei prodotti al posto giusto. Segui l'esempio.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Colonna operazioni -->
        <div class="space-y-3">
          <!-- Esempio -->
          <div class="flex items-center gap-2 flex-wrap p-2 bg-cyan-50 dark:bg-cyan-900/30 rounded-lg">
            <span class="text-gray-700 dark:text-gray-200 font-bold">85,<span class="underline">3</span> × 6,<span class="underline">5</span> = 554<span class="font-bold text-cyan-600 dark:text-cyan-400">,</span><span class="underline">45</span></span>
          </div>

          <% [
            { expr: "9,58 × 29 = ", num: "27782", answer: "277,82" },
            { expr: "7,63 × 43,5 = ", num: "331905", answer: "331,905" },
            { expr: "57,3 × 14,7 = ", num: "84231", answer: "842,31" },
            { expr: "837 × 0,68 = ", num: "56916", answer: "569,16" },
            { expr: "32,4 × 7,32 = ", num: "237168", answer: "237,168" },
            { expr: "5,368 × 12 = ", num: "64416", answer: "64,416" },
            { expr: "5,28 × 7,36 = ", num: "388608", answer: "38,8608" }
          ].each do |item| %>
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-gray-700 dark:text-gray-200"><%= item[:expr] %><%= item[:num] %></span>
              <span class="text-cyan-500">→</span>
              <input type="text" data-correct-answer="<%= item[:answer] %>" class="w-24 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
            </div>
          <% end %>
        </div>

        <!-- Regola a destra -->
        <div class="h-fit p-4 bg-custom-blue dark:bg-cyan-900/30 rounded-2xl">
          <p class="font-bold text-cyan-600 dark:text-cyan-400 mb-2">Moltiplicazioni con i decimali</p>
          <p class="text-gray-700 dark:text-gray-200">
            Esegui come con i numeri interi.<br>
            Nel prodotto finale inserisci la virgola, partendo da destra, dopo tante cifre quante sono in tutto le cifre decimali dei due fattori.
          </p>
        </div>
      </div>
    </div>

    <!-- Esercizio 2 -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(2) %>
        Esegui in riga le seguenti moltiplicazioni.
      </p>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <% [
          { expr: "0,5 × 3 =", answer: "1,5" },
          { expr: "6,7 × 8 =", answer: "53,6" },
          { expr: "0,6 × 0,7 =", answer: "0,42" },
          { expr: "12 × 0,5 =", answer: "6" },
          { expr: "1,24 × 6 =", answer: "7,44" },
          { expr: "163 × 0,5 =", answer: "81,5" },
          { expr: "3,25 × 6 =", answer: "19,5" },
          { expr: "49 × 0,8 =", answer: "39,2" },
          { expr: "13 × 0,2 =", answer: "2,6" },
          { expr: "3,5 × 4 =", answer: "14" },
          { expr: "32,4 × 0,6 =", answer: "19,44" },
          { expr: "3,4 × 9 =", answer: "30,6" }
        ].each do |item| %>
          <div class="flex items-center gap-1 p-2 border border-cyan-400 dark:border-cyan-600 rounded-lg">
            <span class="text-gray-700 dark:text-gray-200"><%= item[:expr] %></span>
            <input type="text" data-correct-answer="<%= item[:answer] %>" class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
          </div>
        <% end %>
      </div>
    </div>

    <!-- Esercizio 3 -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(3) %>
        Calcola in colonna.
      </p>

      <%
        es3_operazioni = [
          { op1: "49,7", op2: "8,6" },
          { op1: "1,89", op2: "74" },
          { op1: "56,7", op2: "3,9" },
          { op1: "4,75", op2: "8,7" },
          { op1: "3,79", op2: "45" },
          { op1: "5,72", op2: "2,6" },
          { op1: "263", op2: "5,8" },
          { op1: "29,7", op2: "3,6" }
        ]
      %>

      <div class="flex flex-wrap gap-4 justify-center">
        <% es3_operazioni.each do |item| %>
          <% moltiplicazione = Moltiplicazione.new(multiplicand: item[:op1], multiplier: item[:op2], show_toolbar: true, show_factors: true) %>
          <%= render 'strumenti/moltiplicazioni/quaderno_moltiplicazione', moltiplicazione: moltiplicazione %>
        <% end %>
      </div>
    </div>

    <!-- Esercizio 4 -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(4) %>
        Calcola in colonna sul quaderno (o clicca sul gruppo per aprire la calcolatrice).
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <%
          esercizio4_gruppi = [
            { lettera: "a", show_partial_carries: true, show_toolbar: false, operazioni: [
              { op1: "38", op2: "6,9", answer: "262,2" },
              { op1: "74", op2: "3,5", answer: "259" },
              { op1: "4,92", op2: "27", answer: "132,84" },
              { op1: "8,05", op2: "36", answer: "289,8" },
              { op1: "7,32", op2: "4,5", answer: "32,94" }
            ]},
            { lettera: "b", operazioni: [
              { op1: "672", op2: "8,3", answer: "5577,6" },
              { op1: "3,59", op2: "2,6", answer: "9,334" },
              { op1: "47,53", op2: "6,8", answer: "323,204" },
              { op1: "7,401", op2: "39", answer: "288,639" },
              { op1: "823", op2: "7,6", answer: "6254,8" }
            ]},
            { lettera: "c", operazioni: [
              { op1: "35", op2: "2,93", answer: "102,55" },
              { op1: "2,8", op2: "7,25", answer: "20,3" },
              { op1: "5,6", op2: "4,76", answer: "26,656" },
              { op1: "5,8", op2: "39,7", answer: "230,26" },
              { op1: "8,6", op2: "4,28", answer: "36,808" }
            ]},
            { lettera: "d", operazioni: [
              { op1: "324", op2: "5,81", answer: "1882,44" },
              { op1: "4,07", op2: "3,29", answer: "13,3903" },
              { op1: "963", op2: "6,07", answer: "5845,41" },
              { op1: "3,52", op2: "7,30", answer: "25,696" },
              { op1: "0,34", op2: "8,07", answer: "2,7438" }
            ]}
          ]
        %>

        <% esercizio4_gruppi.each_with_index do |gruppo, g_idx| %>
          <%
            # Prepara i dati JSON per il gruppo
            operations_data = gruppo[:operazioni].each_with_index.map { |item, i_idx|
              op_data = { operation: "#{item[:op1]}x#{item[:op2]}", targetId: "es4-#{gruppo[:lettera]}-#{i_idx}" }
              op_data[:showPartialCarries] = true if gruppo[:show_partial_carries]
              op_data
            }
          %>
          <div class="p-3 bg-cyan-50 dark:bg-cyan-900/30 rounded-lg">
            <p class="text-gray-700 dark:text-gray-200 font-bold mb-2 flex items-center gap-2">
              <%= gruppo[:lettera] %>.
              <button type="button"
                      data-action="click->quaderno-sidebar#openGroup"
                      data-operations='<%= operations_data.to_json %>'
                      data-type="moltiplicazione"
                      data-group="<%= gruppo[:lettera] %>"
                      class="p-1 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition print-hidden"
                      title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </button>
            </p>
            <ul class="space-y-2">
              <% gruppo[:operazioni].each_with_index do |item, i_idx| %>
                <% op_id = "es4-#{gruppo[:lettera]}-#{i_idx}" %>
                <li class="flex items-center gap-1 flex-wrap">
                  <span class="text-gray-700 dark:text-gray-200"><%= item[:op1] %> × <%= item[:op2] %> =</span>
                  <input type="text"
                         data-operation-id="<%= op_id %>"
                         data-correct-answer="<%= item[:answer] %>"
                         class="w-28 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Sidebar per operazioni in quaderno -->
    <%= render 'shared/quaderno_sidebar' %>

    <%= render 'shared/exercise_controls' %>
  </div>
</div>
