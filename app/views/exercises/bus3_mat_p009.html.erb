<div class="max-w-7xl mx-auto p-3 md:p-6 bg-white" 
     data-controller="exercise-checker">
  <!-- Header -->
  <%= render 'shared/page_header', pagina: @pagina %>

  <!-- Esercizio 3: Collega ogni numero in lettere al corrispondente numero in cifre -->
  <div class="bg-transparent p-4 md:p-8 mb-8" data-controller="flower-matcher">
    <div class="flex items-start gap-3 mb-6">
      <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
        3
      </div>
      <p class="text-base md:text-lg text-gray-700">
        Collega ogni numero in lettere al corrispondente numero in cifre.
      </p>
    </div>

    <div class="relative overflow-scroll md:overflow-hidden p-2">
      <!-- SVG Canvas per disegnare le linee -->
      <svg class="absolute top-0 left-0 w-full h-full pointer-events-none z-30"
           data-flower-matcher-target="canvas">
      </svg>

      <!-- Griglia con numeri in lettere a sinistra e numeri in cifre a destra -->
      <div class="grid grid-cols-3 gap-x-8 gap-y-6 relative z-20">
        <%
          word_numbers = [
            { word: "centodue", number: 102 },
            { word: "centoventi", number: 120 },
            { word: "centotrentuno", number: 131 },
            { word: "duecentonove", number: 209 },
            { word: "seicentosessanta", number: 660 }
          ]

          digit_numbers = [
            { number: 102 },
            { number: 506 },
            { number: 131 },
            { number: 200 },
            { number: 120 },
            { number: 307 },
            { number: 660 },
            { number: 722 },
            { number: 209 },
            { number: 805 }
          ]

          # Riga 1
        %>
        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-centodue"
             data-pair="pair-102">
          <p class="font-bold text-base md:text-lg text-center">centodue</p>
        </div>

        <div class="flex gap-4 items-center justify-center">
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-102"
               data-pair="pair-102">
            <p class="font-bold text-xl text-center">102</p>
          </div>
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-506"
               data-pair="pair-506">
            <p class="font-bold text-xl text-center">506</p>
          </div>
        </div>

        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-duecento"
             data-pair="pair-200">
          <p class="font-bold text-base md:text-lg text-center">duecento</p>
        </div>

        <!-- Riga 2 -->
        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-centoventi"
             data-pair="pair-120">
          <p class="font-bold text-base md:text-lg text-center">centoventi</p>
        </div>

        <div class="flex gap-4 items-center justify-center">
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-131"
               data-pair="pair-131">
            <p class="font-bold text-xl text-center">131</p>
          </div>
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-200"
               data-pair="pair-200">
            <p class="font-bold text-xl text-center">200</p>
          </div>
        </div>

        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-trecentosette"
             data-pair="pair-307">
          <p class="font-bold text-base md:text-lg text-center">trecentosette</p>
        </div>

        <!-- Riga 3 -->
        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-centotrentuno"
             data-pair="pair-131">
          <p class="font-bold text-base md:text-lg text-center">centotrentuno</p>
        </div>

        <div class="flex gap-4 items-center justify-center">
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-120"
               data-pair="pair-120">
            <p class="font-bold text-xl text-center">120</p>
          </div>
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-307"
               data-pair="pair-307">
            <p class="font-bold text-xl text-center">307</p>
          </div>
        </div>

        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-cinquecentosei"
             data-pair="pair-506">
          <p class="font-bold text-base md:text-lg text-center">cinquecentosei</p>
        </div>

        <!-- Riga 4 -->
        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-duecentonove"
             data-pair="pair-209">
          <p class="font-bold text-base md:text-lg text-center">duecentonove</p>
        </div>

        <div class="flex gap-4 items-center justify-center">
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-660"
               data-pair="pair-660">
            <p class="font-bold text-xl text-center">660</p>
          </div>
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-722"
               data-pair="pair-722">
            <p class="font-bold text-xl text-center">722</p>
          </div>
        </div>

        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-ottocentocinque"
             data-pair="pair-805">
          <p class="font-bold text-base md:text-lg text-center">ottocentocinque</p>
        </div>

        <!-- Riga 5 -->
        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-seicentosessanta"
             data-pair="pair-660">
          <p class="font-bold text-base md:text-lg text-center">seicentosessanta</p>
        </div>

        <div class="flex gap-4 items-center justify-center">
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-209"
               data-pair="pair-209">
            <p class="font-bold text-xl text-center">209</p>
          </div>
          <div class="bg-white border-3 border-pink-400 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
               data-action="click->flower-matcher#selectFlower"
               data-flower-matcher-target="flower"
               data-flower-id="num-805"
               data-pair="pair-805">
            <p class="font-bold text-xl text-center">805</p>
          </div>
        </div>

        <div class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition"
             data-action="click->flower-matcher#selectFlower"
             data-flower-matcher-target="flower"
             data-flower-id="word-settecentoventidue"
             data-pair="pair-722">
          <p class="font-bold text-base md:text-lg text-center">settecentoventidue</p>
        </div>
      </div>
    </div>

    <!-- Pulsanti di controllo -->
    <div class="mt-6 flex gap-3 items-center">
      <button class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold rounded-full shadow-lg transition transform hover:scale-105 flex items-center justify-center w-12 h-12"
              data-action="click->flower-matcher#reset"
              title="Ricomincia collegamenti">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Esercizio 4: Osserva le linee e scrivi i numeri nei cartellini -->
  <div class="bg-transparent p-4 md:p-8 mb-8" data-controller="fill-blanks auto-advance">
    <div class="flex items-start gap-3 mb-6">
      <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
        4
      </div>
      <p class="text-base md:text-lg text-gray-700">
        Osserva le linee e scrivi i numeri nei cartellini.
      </p>
    </div>

    <!-- Immagine con input trasparenti sovrapposti -->
    <div class="flex justify-center">
      <div class="relative flex-1 overflow-scroll md:overflow-hidden">
        <!-- Immagine di sfondo -->
        <%= image_tag "bus3_mat/p009/p09_1.jpg",
            alt: "Linee dei numeri con riquadri da completare",
            class: "flex-shrink-0" %>

        <!-- Input trasparenti sovrapposti sui riquadri -->
        <div class="absolute inset-0">
          <%
            # Prima linea (100-140): 7 input
            # Valori: 103, 115, 117, 122, 134, 136, 148
            inputs_line1 = [
              { value: 102, top: "7.3%", left: "14.9%" },
              { value: 113, top: "7.3%", left: "31.5%" },
              { value: 117, top: "7.3%", left: "38.5%" },
              { value: 125, top: "7.3%", left: "50.5%" },
              { value: 132, top: "7.3%", left: "61.5%" },
              { value: 137, top: "7.3%", left: "69%" },
              { value: 145, top: "7.3%", left: "82%" }
            ]

            # Seconda linea (125-165): 7 input
            # Valori: 130, 137, 149, 151, 157, 159, 172
            inputs_line2 = [
              { value: 133, top: "64.2%", left: "24.3%" },
              { value: 142, top: "64.2%", left: "38.5%" },
              { value: 149, top: "64.2%", left: "48.8%" },
              { value: 153, top: "64.2%", left: "55.8%" },
              { value: 160, top: "64.2%", left: "66%" },
              { value: 164, top: "64.2%", left: "72.8%" },
              { value: 172, top: "64.2%", left: "85%" }
            ]

            all_inputs = inputs_line1 + inputs_line2
          %>

          <% all_inputs.each do |input| %>
            <input type="text"
                   data-fill-blanks-target="input"
                   data-correct-answer="<%= input[:value] %>"
                   class="absolute w-[5%] h-[6%] py-2 bg-white/60 hover:bg-white/80 focus:bg-white border border-transparent focus:border-cyan-400 rounded text-center font-bold text-sm md:text-base transition-colors"
                   style="top: <%= input[:top] %>; left: <%= input[:left] %>; transform: translate(-50%, -50%);"
                   maxlength="3"
                   inputmode="numeric"
                   pattern="[0-9]*">
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Esercizio 5: Completa le tabelle -->
  <div class="bg-transparent p-4 md:p-8 mb-8" data-controller="fill-blanks auto-advance">
    <div class="flex items-start gap-3 mb-6">
      <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
        5
      </div>
      <p class="text-base md:text-lg text-gray-700">
        Completa le tabelle.
      </p>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Tabella 1: -2u -->
      <div class="bg-white rounded-lg border-3 border-cyan-400 overflow-hidden">
        <table class="w-full">
          <thead>
            <tr>
              <th colspan="2" class="font-bold text-center py-2 px-3 border-2 border-cyan-400">
                <span class="font-bold text-blue-600">− 2 u</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <% [156, 235, 202, 477].each do |num| %>
              <tr>
                <td class="border-2 border-cyan-400 p-2 text-center">
                  <span class="font-bold text-lg"><%= num %></span>
                </td>
                <td class="border-2 border-cyan-400 p-2 text-center">
                  <input type="text"
                         data-fill-blanks-target="input"
                         data-correct-answer="<%= num - 2 %>"
                         class="w-20 px-2 py-1 border-b-2 border-dotted border-gray-400 text-center font-bold"
                         maxlength="3"
                         inputmode="numeric">
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Tabella 2: +3da -->
      <div class="bg-white rounded-lg border-3 border-cyan-400 overflow-hidden">
        <table class="w-full">
          <thead>
            <tr>
              <th colspan="2" class="font-bold text-center py-2 px-3 border-2 border-cyan-400">
                <span class="font-bold text-blue-600">+ 3 da</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <% [138, 306, 469, 521].each do |num| %>
              <tr>
                <td class="border-2 border-cyan-400 p-2 text-center">
                  <span class="font-bold text-lg"><%= num %></span>
                </td>
                <td class="border-2 border-cyan-400 p-2 text-center">
                  <input type="text"
                         data-fill-blanks-target="input"
                         data-correct-answer="<%= num + 30 %>"
                         class="w-20 px-2 py-1 border-b-2 border-dotted border-gray-400 text-center font-bold"
                         maxlength="3"
                         inputmode="numeric">
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Tabella 3: -3h -->
      <div class="bg-white rounded-lg border-3 border-cyan-400 overflow-hidden">
        <table class="w-full">
          <thead>
            <tr>
              <th colspan="2" class="font-bold text-center py-2 px-3 border-2 border-cyan-400">
                <span class="font-bold text-blue-600">− 3 h</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <% [460, 732, 359, 591].each do |num| %>
              <tr>
                <td class="border-2 border-cyan-400 p-2 text-center">
                  <span class="font-bold text-lg"><%= num %></span>
                </td>
                <td class="border-2 border-cyan-400 p-2 text-center">
                  <input type="text"
                         data-fill-blanks-target="input"
                         data-correct-answer="<%= num - 300 %>"
                         class="w-20 px-2 py-1 border-b-2 border-dotted border-gray-400 text-center font-bold"
                         maxlength="3"
                         inputmode="numeric">
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Tabella 4: +4h -->
      <div class="bg-white rounded-lg border-3 border-cyan-400 overflow-hidden">
        <table class="w-full">
          <thead>
            <tr>
              <th colspan="2" class="font-bold text-center py-2 px-3 border-2 border-cyan-400">
                <span class="font-bold text-blue-600">+ 4 h</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <% [273, 158, 69, 402].each do |num| %>
              <tr>
                <td class="border-2 border-cyan-400 p-2 text-center">
                  <span class="font-bold text-lg"><%= num %></span>
                </td>
                <td class="border-2 border-cyan-400 p-2 text-center">
                  <input type="text"
                         data-fill-blanks-target="input"
                         data-correct-answer="<%= num + 400 %>"
                         class="w-20 px-2 py-1 border-b-2 border-dotted border-gray-400 text-center font-bold"
                         maxlength="3"
                         inputmode="numeric">
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Footer con controlli -->
  <%= render 'shared/exercise_controls', color: 'cyan' %>
</div>
