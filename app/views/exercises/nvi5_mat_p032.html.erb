<div class="max-w-6xl mx-auto bg-white dark:bg-gray-900 text-black dark:text-white p-3 md:p-6 transition-colors duration-300"
     data-controller="exercise-checker text-toggle font-controls operation-viewer"
     data-text-toggle-target="content"
     data-font-controls-target="content">

  <%= render 'shared/page_header', pagina: @pagina %>

  <div class="space-y-6">
    <!-- Problema introduttivo -->
    <div class="p-4 md:p-6">
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <div class="p-4 bg-custom-blue-light dark:bg-cyan-900/40 rounded-lg mb-4">
            <p class="text-gray-800 dark:text-gray-200">
              Le galline della fattoria Colle Fiorito producono 185 uova al giorno.<br>
              Quante uova vengono prodotte in 25 giorni?
            </p>
          </div>

          <p class="text-gray-800 dark:text-gray-200 mb-4">
            Per rispondere alla domanda, devi eseguire una moltiplicazione.<br>
            Ricordi? La moltiplicazione è l'operazione che serve per <strong class="text-<%= @pagina.base_color %>-600 dark:text-<%= @pagina.base_color %>-400">aggiungere più volte la stessa quantità</strong> o per <strong class="text-<%= @pagina.base_color %>-600 dark:text-<%= @pagina.base_color %>-400">calcolare le combinazioni</strong>.
          </p>
          <p class="text-gray-800 dark:text-gray-200">
            In questo caso devi eseguire <strong class="text-<%= @pagina.base_color %>-600 dark:text-<%= @pagina.base_color %>-400">185 × 25</strong>.
          </p>
        </div>
      </div>
    </div>

    <!-- Osserva e leggi -->
    <div class="p-4 md:p-6 bg-white dark:bg-gray-800 border-3 border-<%= @pagina.base_color %>-400 dark:border-<%= @pagina.base_color %>-500 rounded-2xl">
      <h2 class="font-bold text-<%= @pagina.base_color %>-600 dark:text-<%= @pagina.base_color %>-400 mb-6">
        <span class="text-pink-600 dark:text-pink-400">•</span> Osserva e leggi.
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Step 1 -->
        <div class="p-4 text-center">
          <%= image_tag "nvi5_mat/p032/p032_01.jpg", alt: "Step 1", class: "mx-auto mb-3 dark:bg-white dark:rounded-lg dark:p-1" %>
          <p class="text-gray-700 dark:text-gray-200 text-sm">
            Moltiplica le unità del 2° fattore per tutte le cifre del 1° fattore.
          </p>
        </div>
        <!-- Step 2 -->
        <div class="p-4 text-center">
          <%= image_tag "nvi5_mat/p032/p032_02.jpg", alt: "Step 2", class: "mx-auto mb-3 dark:bg-white dark:rounded-lg dark:p-1" %>
          <p class="text-gray-700 dark:text-gray-200 text-sm">
            Moltiplica le decine del 2° fattore per tutte le cifre del 1° fattore.
          </p>
        </div>
        <!-- Step 3 -->
        <div class="p-4 text-center">
          <%= image_tag "nvi5_mat/p032/p032_03.jpg", alt: "Step 3", class: "mx-auto mb-3 dark:bg-white dark:rounded-lg dark:p-1" %>
          <p class="text-gray-700 dark:text-gray-200 text-sm">
            Addiziona i prodotti parziali.
          </p>
        </div>
      </div>
    
      <!-- BOX: Ora puoi rispondere -->
      <div class="mt-6 p-4">
        <div class="flex items-center gap-2 flex-wrap text-gray-800 dark:text-gray-200">
          <span>Ora puoi rispondere:</span>
          <div class="bg-custom-blue-light dark:bg-cyan-900/40 px-3 py-1 rounded-lg inline-flex">
            <%= render 'shared/fill_item', segments: [
              "In 25 giorni vengono prodotte",
              { answer: "4625" },
              "uova."
            ] %>
          </div>
        </div>
      </div>
    </div>

    <!-- ESERCIZI -->
    <div class="p-4 md:p-6 bg-orange-100 dark:bg-orange-900/30 rounded-lg">
      <div class="grid grid-cols-1 md:grid-cols-2 divide-y-2 md:divide-y-0 md:divide-x-2 divide-pink-400">
        <!-- Colonna sinistra -->
        <div class="p-4 space-y-6">
          <!-- Esercizio 1 -->
          <div>
            <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
              <%= numero_esercizio_badge(1) %>
              Calcola in colonna sul quaderno.
            </p>

            <%
              es1_gruppi = [
                { lettera: "a", operazioni: [
                  { op: "42x15", answer: "630" },
                  { op: "88x22", answer: "1936" },
                  { op: "263x34", answer: "8942" }
                ]},
                { lettera: "b", operazioni: [
                  { op: "38x24", answer: "912" },
                  { op: "54x35", answer: "1890" },
                  { op: "312x40", answer: "12480" }
                ]},
                { lettera: "c", operazioni: [
                  { op: "92x36", answer: "3312" },
                  { op: "79x32", answer: "2528" },
                  { op: "106x78", answer: "8268" }
                ]},
                { lettera: "d", operazioni: [
                  { op: "74x26", answer: "1924" },
                  { op: "48x53", answer: "2544" },
                  { op: "250x67", answer: "16750" }
                ]}
              ]
            %>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <% es1_gruppi.each do |gruppo| %>
                <%
                  operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
                    { operation: item[:op], targetId: "es1-#{gruppo[:lettera]}-#{idx}" }
                  }
                %>
                <div class="p-3">
                  <p class="text-<%= @pagina.base_color %>-600 dark:text-<%= @pagina.base_color %>-400 font-bold mb-2 flex items-center gap-2">
                    <%= gruppo[:lettera] %>.
                    <button type="button"
                            data-action="click->operation-viewer#openGroup"
                            data-operations='<%= operations_data.to_json %>'
                            data-type="moltiplicazione"
                            data-group="<%= gruppo[:lettera] %>"
                            class="p-1 text-<%= @pagina.base_color %>-400 hover:text-<%= @pagina.base_color %>-600 dark:hover:text-<%= @pagina.base_color %>-300 transition print-hidden"
                            title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </p>
                  <ul class="space-y-2">
                    <% gruppo[:operazioni].each_with_index do |item, idx| %>
                      <li class="flex items-center gap-2 flex-wrap">
                        <span class="text-gray-700 dark:text-gray-200"><%= item[:op].gsub('x', ' × ') %> =</span>
                        <input type="text"
                               data-operation-id="es1-<%= gruppo[:lettera] %>-<%= idx %>"
                               data-correct-answer="<%= item[:answer] %>"
                               class="w-20 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Esercizio 2 -->
          <div class="text-gray-700 dark:text-gray-200">
            <p>
              <%= numero_esercizio_badge(2) %>
              Il biglietto del teatro costa a ognuno dei 23 alunni della 5ª C 8 euro. Quanto spendono complessivamente?
            </p>
            <div class="flex justify-end mt-2">
              <%= render 'shared/fill_item', prefix: "€", answer: "184" %>
            </div>
          </div>

          <!-- Esercizio 3 -->
          <div class="text-gray-700 dark:text-gray-200">
            <p>
              <%= numero_esercizio_badge(3) %>
              Maura è in gelateria e può scegliere tra il cono e la coppetta e 4 gusti di gelato. Tra quante combinazioni può scegliere?
            </p>
            <div class="flex justify-end mt-2">
              <%= render 'shared/fill_item', answer: "8" %>
            </div>
          </div>
        </div>

        <!-- Colonna destra - AllenaMente -->
        <div class="p-4">
          <div class="p-4 bg-yellow-200 dark:bg-yellow-900/40 rounded-lg">
            <p class="font-bold text-red-600 dark:text-red-400 mb-3">AllenaMente!</p>
            <p class="text-gray-800 dark:text-gray-200">
              Luca deve comprare 6 confezioni di biscotti al prezzo di 3 euro l'una. Oggi c'è l'offerta "prendi 3 paghi 2". Quanto risparmia Luca?<br><br>
              Risolvi sul quaderno e spiega come hai fatto a rispondere.
            </p>
          </div>
        </div>
      </div>
    </div>

    <%= render 'shared/quaderno_link', pagine: [188] %>

    <%= render 'shared/operation_viewer' %>
    <%= render 'shared/exercise_controls' %>
  </div>
</div>
