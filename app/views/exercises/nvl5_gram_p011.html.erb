<div class="max-w-6xl mx-auto p-3 md:p-8 bg-white rounded-lg shadow-lg" data-controller="exercise-checker">

  <%= render 'shared/page_header', pagina: @pagina %>

  <!-- Exercise 4: Circle correct alternative -->
  <div class="mb-6 md:mb-8 bg-white rounded-lg p-4 md:p-6">
    <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4">
      <span class="bg-pink-600 text-white rounded-full w-8 h-8 md:w-10 md:h-10 inline-flex items-center justify-center mr-2">4</span>
      Cerchia l'alternativa corretta.
    </h2>

    <div class="space-y-4" data-controller="word-choice">
      <%
        sentences = [
          {
            parts: ['Serve il sale? ', ['Lo', 'L\'ho'], ' prendo subito.'],
            correct: ['Lo']
          },
          {
            parts: ['Il libro sui fantasmi? ', ['Lo', 'L\'ho'], ' restituito stamattina in biblioteca.'],
            correct: ['L\'ho']
          },
          {
            parts: ['La mamma ', ['la', 'l\'ha'], ' detto mille volte a Ginevra che non vuole animali in casa.'],
            correct: ['l\'ha']
          },
          {
            parts: ['Sai se verrà anche Elisa? Io non ', ['lo', 'l\'ho'], ' so.'],
            correct: ['lo']
          }
        ]

        group_counter = 0
      %>

      <% sentences.each_with_index do |sentence, sentence_idx| %>
        <div class="px-2 py-0 rounded-lg">
          <p class="text-base md:text-lg leading-relaxed inline">•
            <% sentence[:parts].each_with_index do |part, part_idx| %>
              <% if part.is_a?(Array) %>
                <%
                  current_group = "s#{sentence_idx}_g#{group_counter}"
                  correct_word = sentence[:correct][group_counter % sentence[:correct].length]
                  group_counter += 1
                %>
                <% part.each_with_index do |word, word_idx| %>
                  <span class="px-1 py-0.5 rounded cursor-pointer hover:bg-pink-100 transition"
                        data-word-choice-target="word"
                        data-group="<%= current_group %>"
                        data-correct="<%= word == correct_word %>"
                        data-action="click->word-choice#select"><%= word %></span><% if word_idx < part.length - 1 %><span class="text-pink-400">/</span><% end %>
                <% end %>
              <% else %>
                <%= part %>
              <% end %>
            <% end %>
          </p>
        </div>
        <% group_counter = 0 %>
      <% end %>
    </div>
  </div>

  <!-- Exercise 5: Complete sentences -->
  <div class="mb-6 md:mb-8 bg-white rounded-lg p-4 md:p-6">
    <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4">
      <span class="bg-pink-600 text-white rounded-full w-8 h-8 md:w-10 md:h-10 inline-flex items-center justify-center mr-2">5</span>
      Completa le frasi con <span class="font-bold text-cyan-700">LO</span> / <span class="font-bold text-cyan-700">L'HO</span>, <span class="font-bold text-cyan-700">L'HAI</span>, <span class="font-bold text-cyan-700">LA</span> / <span class="font-bold text-cyan-700">L'HA</span>, <span class="font-bold text-cyan-700">L'ANNO</span> / <span class="font-bold text-cyan-700">L'HANNO</span>.
    </h2>

    <div class="space-y-4" data-controller="fill-blanks">
      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• Ormai <input type="text"
               class="border-b-3 border-pink-500 bg-white w-20 md:w-24 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="l'hanno"
               data-correct-answer="l'hanno"
               maxlength="7"> visto tutti!</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• Non trovo il libro: <input type="text"
               class="border-b-3 border-pink-500 bg-white w-16 md:w-20 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="l'hai"
               data-correct-answer="l'hai"
               maxlength="5"> preso tu o <input type="text"
               class="border-b-3 border-pink-500 bg-white w-16 md:w-20 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="l'ha"
               data-correct-answer="l'ha"
               maxlength="4"> spostato la tua compagna di banco?</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• Te <input type="text"
               class="border-b-3 border-pink-500 bg-white w-16 md:w-20 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="l'ha"
               data-correct-answer="l'ha"
               maxlength="4"> detto <input type="text"
               class="border-b-3 border-pink-500 bg-white w-12 md:w-16 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="la"
               data-correct-answer="la"
               maxlength="2"> mamma che <input type="text"
               class="border-b-3 border-pink-500 bg-white w-20 md:w-24 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="l'anno"
               data-correct-answer="l'anno"
               maxlength="6"> prossimo ci trasferiremo?</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• Gli zii verranno a Roma: ce <input type="text"
               class="border-b-3 border-pink-500 bg-white w-20 md:w-24 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="l'hanno"
               data-correct-answer="l'hanno"
               maxlength="7"> scritto!</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• <input type="text"
               class="border-b-3 border-pink-500 bg-white w-12 md:w-16 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="Lo"
               data-correct-answer="Lo"
               maxlength="2"> sai che non <input type="text"
               class="border-b-3 border-pink-500 bg-white w-16 md:w-20 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="l'ho"
               data-correct-answer="l'ho"
               maxlength="4"> fatto apposta, è inutile che te <input type="text"
               class="border-b-3 border-pink-500 bg-white w-12 md:w-16 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="la"
               data-correct-answer="la"
               maxlength="2"> prendi.</span>
      </div>
    </div>
  </div>

  <!-- Exercise 6: Write sentences with word pairs -->
  <div class="mb-6 md:mb-8 bg-white rounded-lg p-4 md:p-6">
    <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4">
      <span class="bg-pink-600 text-white rounded-full w-8 h-8 md:w-10 md:h-10 inline-flex items-center justify-center mr-2">6</span>
      Scrivi una frase utilizzando la coppia di parole indicata, come nell'esempio.
    </h2>

    <div class="space-y-4">
      <% word_pairs = [
        {words: 'LO • L\'HO', border_color: 'yellow', example: 'Ho preparato lo zaino e l\'ho messo in macchina.'},
        {words: 'LA • L\'HA', border_color: 'purple', example: nil},
        {words: 'L\'HA • LÀ', border_color: 'green', example: nil},
        {words: 'L\'HA • LA', border_color: 'orange', example: nil}
      ] %>

      <% word_pairs.each do |pair| %>
        <div class="flex <%= pair[:example] ? 'items-center' : 'items-start' %> gap-3">
          <div class="bg-white border-4 <%= case pair[:border_color]
            when 'yellow' then 'border-yellow-500'
            when 'purple' then 'border-purple-500'
            when 'orange' then 'border-orange-500'
            when 'green' then 'border-green-500'
            end %> text-black px-4 py-2 rounded-lg font-bold flex-shrink-0 ml-10"><%= pair[:words] %></div>
          <% if pair[:example] %>
            <div class="flex-1 text-base md:text-lg text-cyan-700"><%= pair[:example] %></div>
          <% else %>
            <textarea class="flex-1 border-2 border-dotted border-gray-400 rounded-lg p-3 focus:outline-none text-base md:text-lg"
                      rows="2"
                      placeholder="Scrivi una frase con <%= pair[:words] %>..."></textarea>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Exercise 7: Complete with GLIELO/GLIEL'HO etc -->
  <div class="mb-6 md:mb-8 bg-white rounded-lg p-4 md:p-6">
    <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4">
      <span class="bg-pink-600 text-white rounded-full w-8 h-8 md:w-10 md:h-10 inline-flex items-center justify-center mr-2">7</span>
      Completa le frasi con <span class="font-bold text-cyan-700">GLIELO</span> / <span class="font-bold text-cyan-700">GLIEL'HO</span>, <span class="font-bold text-cyan-700">GLIELA</span> / <span class="font-bold text-cyan-700">GLIEL'HA</span>, <span class="font-bold text-cyan-700">GLIEL'HAI</span>, <span class="font-bold text-cyan-700">GLIEL'HANNO</span>.
    </h2>

    <div class="space-y-4" data-controller="fill-blanks">
      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• Questo ombrello è di Davide, <input type="text"
               class="border-b-3 border-pink-500 bg-white w-20 md:w-24 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="glielo"
               data-correct-answer="glielo"
               maxlength="7"> restituirò domani.</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• Vuoi che <input type="text"
               class="border-b-3 border-pink-500 bg-white w-20 md:w-24 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="gliela"
               data-correct-answer="gliela"
               maxlength="7"> porti io la frutta?</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• Mario ha saputo del disguido, <input type="text"
               class="border-b-3 border-pink-500 bg-white w-24 md:w-28 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="gliel'ha"
               data-correct-answer="gliel'ha"
               maxlength="8"> detto Luca.</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• Questo pallone è nuovo: <input type="text"
               class="border-b-3 border-pink-500 bg-white w-28 md:w-32 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="gliel'hanno"
               data-correct-answer="gliel'hanno"
               maxlength="11"> comperato i suoi genitori.</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• – <input type="text"
               class="border-b-3 border-pink-500 bg-white w-24 md:w-28 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="Gliel'hai"
               data-correct-answer="Gliel'hai"
               maxlength="9"> precisato che non ci sarò alla festa?</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• – No, non <input type="text"
               class="border-b-3 border-pink-500 bg-white w-24 md:w-28 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="gliel'ho"
               data-correct-answer="gliel'ho"
               maxlength="8"> ancora comunicato.</span>
      </div>

      <div class="px-2 py-0 rounded-lg flex flex-wrap items-center gap-1 text-base md:text-lg">
        <span>• Mio fratello è capriccioso e qualche volta <input type="text"
               class="border-b-3 border-pink-500 bg-white w-24 md:w-28 text-center focus:outline-none focus:border-pink-700 inline"
               data-fill-blanks-target="input"
               data-answer="glielo"
               data-correct-answer="glielo"
               maxlength="7"> faccio notare.</span>
      </div>
    </div>
  </div>

  <!-- Reference note -->
  <%
    base_color = @pagina&.base_color || "blue"
    color_map = {
      "purple" => "text-purple-700 hover:text-purple-900",
      "blue" => "text-blue-700 hover:text-blue-900",
      "cyan" => "text-cyan-700 hover:text-cyan-900",
      "green" => "text-green-700 hover:text-green-900",
      "orange" => "text-orange-700 hover:text-orange-900",
      "red" => "text-red-700 hover:text-red-900",
      "pink" => "text-pink-700 hover:text-pink-900"
    }
    link_color = color_map[base_color] || "text-blue-700 hover:text-blue-900"
  %>
  <div class="mb-6 text-right font-bold">
    <p class="text-lg md:text-xl <%= link_color %>">
      Esercizi pp. <%= link_to "136", pagina_path("nvl5_gram_p136"), class: "#{link_color} underline" %>-<%= link_to "137", pagina_path("nvl5_gram_p137"), class: "#{link_color} underline" %>
    </p>
  </div>

  <!-- Exercise Controls -->
  <%= render 'shared/exercise_controls', color: 'pink', current_page: 'nvl5_gr_p011' %>
</div>
