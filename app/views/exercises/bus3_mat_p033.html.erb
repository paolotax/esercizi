<div class="max-w-7xl mx-auto p-3 md:p-6 bg-white dark:bg-gray-900 text-black dark:text-white transition-colors duration-300"
     data-controller="exercise-checker fill-blanks auto-advance text-toggle font-controls"
     data-text-toggle-target="content"
     data-font-controls-target="content">

  <!-- Header -->
  <%= render 'shared/page_header', pagina: @pagina %>

  <!-- Esercizio 1: Box azzurro con spiegazione -->
  <div class="bg-[#C7EAFB] dark:bg-cyan-900/40 p-4 md:p-6 -ml-3 md:-ml-0 -mr-3 md:mr-0 mb-8">

    <p class="text-gray-700 dark:text-gray-200 mb-4">
      <%= numero_esercizio_badge(1, colore: 'red-500') %>
      Calcola in colonna, poi verifica con la prova se il risultato Ã¨ corretto.
    </p>

    <div class="flex flex-col md:flex-row gap-6 mb-6">
      <!-- Immagine esempio -->
      <div class="flex justify-center items-center flex-shrink-0  md:pr-10">
        <div class="bg-transparent dark:bg-white rounded-md p-1">
          <%= image_tag "bus3_mat/p033/p33_1.jpg",
              alt: "Esempio prova sottrazione",
              class: "block" %>
        </div>
      </div>

      <!-- Box teorico -->
      <div class="bg-pink-50 dark:bg-pink-900/30 border-3 border-pink-400 dark:border-pink-500 rounded-lg p-6 flex items-center my-auto">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">ðŸ˜Š</div>
          <p class="text-gray-700 dark:text-gray-200">
            <strong>Puoi usare l'<span class="text-cyan-600 dark:text-cyan-400">addizione</span> per fare la prova, cioÃ¨ verificare se il risultato di una sottrazione Ã¨ corretto. Se al resto di una sottrazione aggiungi il sottraendo, ottieni di nuovo il minuendo.</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Esercizio 2: Calcola in colonna e fai la prova -->
  <div class="bg-transparent p-4 md:p-8 mb-8">
    
    <p class="text-gray-700 dark:text-gray-200 mb-4">
      <%= numero_esercizio_badge(2, colore: 'red-500') %>
      Calcola in colonna e fai la prova.
    </p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Prima coppia: 862 - 184 -->
      <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-6">
        <%= sottrazione_grid 862, 184, show_operands: true, show_borrow: true, style: :column %>
        <div class="font-bold text-cyan-600 dark:text-cyan-400 rotate-90 md:rotate-0">â†’</div>
        <%= addizione_grid [184, 678], show_carry: true, style: :column %>
      </div>

      <!-- Seconda coppia: 536 - 275 -->
      <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-6">
        <%= sottrazione_grid 536, 275, show_operands: true, show_borrow: true, style: :column %>
        <div class="font-bold text-cyan-600 dark:text-cyan-400 rotate-90 md:rotate-0">â†’</div>
        <%= addizione_grid [275, 261], show_carry: true, style: :column %>
      </div>
    </div>
  </div>

  <!-- Grid per esercizi 3, 4, 5 -->
  <div class="bg-transparent p-4 md:p-8 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-10">

      <!-- Esercizio 3 -->
      <div data-controller="operation-viewer">

        <p class="text-gray-700 dark:text-gray-200 mb-4">
          <%= numero_esercizio_badge(3, colore: 'red-500') %>
          Calcola in colonna sul quaderno e fai la prova.
        </p>

        <%
          es3_operazioni = [
            { op: "714-354", answer: "360" },
            { op: "681-159", answer: "522" },
            { op: "576-328", answer: "248" },
            { op: "487-188", answer: "299" }
          ]
          es3_operations_data = es3_operazioni.each_with_index.map { |item, idx|
            { operation: item[:op], targetId: "es3-#{idx}" }
          }
        %>

        <div class="bg-cyan-50 dark:bg-cyan-900/30 p-4 rounded-lg border-2 border-transparent hover:border-cyan-400 transition">
          <p class="font-bold text-cyan-600 dark:text-cyan-400 mb-3 flex items-center gap-2">
            <button type="button"
                    data-action="click->operation-viewer#openGroup"
                    data-operations='<%= es3_operations_data.to_json %>'
                    data-type="sottrazione"
                    data-layout="column"
                    data-display="modal"
                    data-group="es3"
                    class="p-1 text-gray-400 hover:text-cyan-600 dark:hover:text-cyan-400 transition print-hidden"
                    title="Apri nella calcolatrice">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
            </button>
          </p>
          <ul class="grid grid-cols-2 gap-4">
            <% es3_operazioni.each_with_index do |item, idx| %>
              <li class="flex items-center gap-2 flex-wrap dark:text-white">
                <span><%= item[:op].gsub('-', ' - ') %> =</span>
                <input type="text"
                       data-operation-id="es3-<%= idx %>"
                       data-correct-answer="<%= item[:answer] %>"
                       class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent">
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Modal -->
        <%= render 'shared/operation_viewer', display: :modal, title: "Sottrazioni in colonna", color: "cyan" %>
      </div>

      <!-- Esercizio 5 -->
      <div>

        <p class="text-gray-700 dark:text-gray-200 mb-4">
          <%= numero_esercizio_badge(5, colore: 'red-500') %>
          Calcola in colonna sul quaderno. Poi indica con una X se il risultato Ã¨ vero (V) o falso (F).
        </p>

        <div class="space-y-3">
          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">1875 - 1762 = 113</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_1" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold dark:text-white">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_1" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold dark:text-white">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">2256 - 2045 = 221</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_2" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold dark:text-white">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_2" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold dark:text-white">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">2365 - 1429 = 936</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_3" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold dark:text-white">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_3" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold dark:text-white">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">6952 - 6513 = 429</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_4" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold dark:text-white">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_4" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold dark:text-white">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">2258 - 266 = 2012</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_5" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold dark:text-white">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_5" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold dark:text-white">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">4515 - 2244 = 2271</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_6" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold dark:text-white">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_6" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold dark:text-white">F</span>
              </label>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Esercizio 4: Due colonne -->
  <div class="bg-transparent p-4 md:p-8 mb-8" data-controller="operation-viewer">

    <p class="text-gray-700 dark:text-gray-200 mb-4">
      <%= numero_esercizio_badge(4, colore: 'red-500') %>
      Calcola in colonna sul quaderno e fai la prova.
    </p>

    <%
      es4_gruppi = [
        { lettera: "a", colore: "orange", operazioni: [
          { op: "5298-4182", answer: "1116" },
          { op: "3698-2354", answer: "1344" },
          { op: "1268-1204", answer: "64" },
          { op: "2369-658", answer: "1711" },
          { op: "6574-2684", answer: "3890" },
          { op: "2641-1592", answer: "1049" }
        ]},
        { lettera: "b", colore: "blue", operazioni: [
          { op: "1269-1108", answer: "161" },
          { op: "2821-1312", answer: "1509" },
          { op: "2408-2157", answer: "251" },
          { op: "8965-3265", answer: "5700" },
          { op: "8985-715", answer: "8270" },
          { op: "4930-2614", answer: "2316" }
        ]}
      ]
    %>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
      <% es4_gruppi.each do |gruppo| %>
        <%
          operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
            { operation: item[:op], targetId: "es4-#{gruppo[:lettera]}-#{idx}" }
          }
        %>
        <div class="bg-<%= gruppo[:colore] %>-50 dark:bg-<%= gruppo[:colore] %>-900/30 p-4 rounded-lg border-2 border-transparent hover:border-<%= gruppo[:colore] %>-400 transition">
          <p class="font-bold text-<%= gruppo[:colore] %>-600 dark:text-<%= gruppo[:colore] %>-400 mb-3 flex items-center gap-2">
            <%= gruppo[:lettera] %>.
            <button type="button"
                    data-action="click->operation-viewer#openGroup"
                    data-operations='<%= operations_data.to_json %>'
                    data-type="sottrazione"
                    data-layout="column"
                    data-display="modal"
                    data-group="<%= gruppo[:lettera] %>"
                    class="p-1 text-gray-400 hover:text-<%= gruppo[:colore] %>-600 dark:hover:text-<%= gruppo[:colore] %>-400 transition print-hidden"
                    title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
            </button>
          </p>
          <ul class="space-y-2">
            <% gruppo[:operazioni].each_with_index do |item, idx| %>
              <li class="flex items-center gap-2 flex-wrap dark:text-white">
                <span><%= item[:op].gsub('-', ' - ') %> =</span>
                <input type="text"
                       data-operation-id="es4-<%= gruppo[:lettera] %>-<%= idx %>"
                       data-correct-answer="<%= item[:answer] %>"
                       class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent">
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

    <!-- Modal -->
    <%= render 'shared/operation_viewer', display: :modal, title: "Sottrazioni in colonna", color: "cyan" %>
  </div>

  <!-- Footer con controlli -->
  <%= render 'shared/exercise_controls' %>
</div>
