<div class="max-w-7xl mx-auto p-3 md:p-6 bg-white dark:bg-gray-900 text-black dark:text-white transition-colors duration-300"
     data-controller="exercise-checker fill-blanks auto-advance text-toggle font-controls"
     data-page-viewer-image-url-value="<%= asset_path('bus3_mat/p027/page.png') %>"
     data-text-toggle-target="content"
     data-font-controls-target="content">

  <!-- Header -->
  <%= render 'shared/page_header', pagina: @pagina %>

  <!-- Esercizio 1: Calcola in colonna e verifica -->
  <div class="bg-[#C7EAFB] dark:bg-cyan-900/40 -ml-3 md:-ml-0 -mr-3 md:mr-0 p-4 md:p-6 mb-8">
    <div class="flex items-start gap-3 mb-6">
      <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
        1
      </div>
      <p class="text-gray-700 dark:text-gray-200">
        <strong>Calcola in colonna, poi verifica con la prova se il risultato Ã¨ corretto.</strong>
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Immagine esempio -->
      <div class="flex justify-center">
        <%= image_tag "bus3_mat/p027/p27_1.jpg",
            alt: "Esempio prova addizione",
            class: "max-w-full w-full" %>
      </div>

      <!-- Box teorico -->
      <div class="bg-pink-50 dark:bg-pink-900/30 border-3 border-pink-400 dark:border-pink-500 rounded-lg p-6 flex items-center">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">ðŸ˜Š</div>
          <p class="text-gray-700 dark:text-gray-200">
            <strong>Puoi usare la <span class="text-cyan-600 dark:text-cyan-400">proprietÃ  commutativa</span> per fare la prova, cioÃ¨ verificare se il risultato di un'addizione Ã¨ corretto.</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Esercizio 2: Calcola in colonna e fai la prova -->
  <div class="bg-transparent p-4 md:p-8 mb-8">
    <div class="flex items-start gap-3 mb-6">
      <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
        2
      </div>
      <p class="text-gray-700 dark:text-gray-200">
        <strong>Calcola in colonna e fai la prova.</strong>
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Prima coppia: 187 + 463 -->
      <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-6">
        <%= addizione_grid [187, 463], show_addends: true, show_carry: true, style: :column %>
        <div class="font-bold text-cyan-600 dark:text-cyan-400 rotate-90 md:rotate-0">â†’</div>
        <%= addizione_grid [463, 187], show_carry: true, style: :column %>
      </div>

      <!-- Seconda coppia: 518 + 229 -->
      <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-6">
        <%= addizione_grid [518, 229], show_addends: true, show_carry: true, style: :column %>
        <div class="font-bold text-cyan-600 dark:text-cyan-400 rotate-90 md:rotate-0">â†’</div>
        <%= addizione_grid [229, 518], show_carry: true, style: :column %>
      </div>
    </div>
  </div>

  <!-- Grid per esercizi 3, 4, 5 -->
  <div class="bg-transparent p-4 md:p-8 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-10">

      <!-- Esercizio 3 -->
      <div data-controller="operation-viewer">
        <div class="flex items-start gap-3 mb-6">
          <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
            3
          </div>
          <p class="text-gray-700 dark:text-gray-200">
            <strong>Calcola in colonna sul quaderno e fai la prova.</strong>
          </p>
        </div>

        <%
          es3_operazioni = [
            { op: "721+416", answer: "1137" },
            { op: "819+111", answer: "930" },
            { op: "604+256", answer: "860" },
            { op: "408+395", answer: "803" }
          ]
          es3_operations_data = es3_operazioni.each_with_index.map { |item, idx|
            { operation: item[:op], targetId: "es3-#{idx}" }
          }
        %>

        <div class="bg-cyan-50 dark:bg-cyan-900/30 p-4 rounded-lg border-2 border-transparent hover:border-cyan-400 transition">
          <p class="font-bold text-cyan-600 dark:text-cyan-400 mb-3 flex items-center gap-2">
            <button type="button"
                    data-action="click->operation-viewer#openGroup"
                    data-operations='<%= es3_operations_data.to_json %>'
                    data-type="addizione"
                    data-layout="column"
                    data-display="modal"
                    data-group="es3"
                    class="p-1 text-gray-400 hover:text-cyan-600 dark:hover:text-cyan-400 transition print-hidden"
                    title="Apri nella calcolatrice">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
            </button>
          </p>
          <ul class="space-y-2">
            <% es3_operazioni.each_with_index do |item, idx| %>
              <li class="flex items-center gap-2 flex-wrap dark:text-white">
                <span><%= item[:op].gsub('+', ' + ') %> =</span>
                <input type="text"
                       data-operation-id="es3-<%= idx %>"
                       data-correct-answer="<%= item[:answer] %>"
                       class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent">
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Modal -->
        <%= render 'shared/operation_viewer', display: :modal, title: "Addizioni in colonna", color: "cyan" %>
      </div>

      <!-- Esercizio 5 -->
      <div>
        <div class="flex items-start gap-3 mb-6">
          <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
            5
          </div>
          <p class="text-gray-700 dark:text-gray-200">
            <strong>Calcola in colonna sul quaderno. Poi indica con una X se l'operazione Ã¨ vera (V) o falsa (F).</strong>
          </p>
        </div>

        <div class="space-y-3">
          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">5127 + 936 = 6063</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_1" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_1" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">844 + 1256 = 2200</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_2" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_2" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">2365 + 125 = 2490</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_3" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_3" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">2258 + 266 = 2562</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_4" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_4" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">4512 + 2571 = 7083</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_5" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_5" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold">F</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between gap-4">
            <span class="text-gray-700 dark:text-gray-200">4872 + 1487 = 6359</span>
            <div class="flex gap-3">
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_6" data-correct-answer="true" class="w-5 h-5">
                <span class="font-bold">V</span>
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="ex5_6" data-correct-answer="false" class="w-5 h-5">
                <span class="font-bold">F</span>
              </label>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Esercizio 4: Due colonne -->
  <div class="bg-transparent p-4 md:p-8 mb-8" data-controller="operation-viewer">
    <div class="flex items-start gap-3 mb-6">
      <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
        4
      </div>
      <p class="text-gray-700 dark:text-gray-200">
        <strong>Calcola in colonna sul quaderno e fai la prova.</strong>
      </p>
    </div>

    <%
      es4_gruppi = [
        { lettera: "a", colore: "orange", operazioni: [
          { op: "2416+731", answer: "3147" },
          { op: "3632+89", answer: "3721" },
          { op: "3069+1916", answer: "4985" },
          { op: "2215+886", answer: "3101" },
          { op: "1529+306", answer: "1835" },
          { op: "1058+215", answer: "1273" }
        ]},
        { lettera: "b", colore: "blue", operazioni: [
          { op: "897+562", answer: "1459" },
          { op: "5695+968", answer: "6663" },
          { op: "5569+305", answer: "5874" },
          { op: "1422+753", answer: "2175" },
          { op: "6024+1881", answer: "7905" },
          { op: "2293+437", answer: "2730" }
        ]}
      ]
    %>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
      <% es4_gruppi.each do |gruppo| %>
        <%
          operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
            { operation: item[:op], targetId: "es4-#{gruppo[:lettera]}-#{idx}" }
          }
        %>
        <div class="bg-<%= gruppo[:colore] %>-50 dark:bg-<%= gruppo[:colore] %>-900/30 p-4 rounded-lg border-2 border-transparent hover:border-<%= gruppo[:colore] %>-400 transition">
          <p class="font-bold text-<%= gruppo[:colore] %>-600 dark:text-<%= gruppo[:colore] %>-400 mb-3 flex items-center gap-2">
            <%= gruppo[:lettera] %>.
            <button type="button"
                    data-action="click->operation-viewer#openGroup"
                    data-operations='<%= operations_data.to_json %>'
                    data-type="addizione"
                    data-layout="column"
                    data-display="modal"
                    data-group="<%= gruppo[:lettera] %>"
                    class="p-1 text-gray-400 hover:text-<%= gruppo[:colore] %>-600 dark:hover:text-<%= gruppo[:colore] %>-400 transition print-hidden"
                    title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
            </button>
          </p>
          <ul class="space-y-2">
            <% gruppo[:operazioni].each_with_index do |item, idx| %>
              <li class="flex items-center gap-2 flex-wrap dark:text-white">
                <span><%= item[:op].gsub('+', ' + ') %> =</span>
                <input type="text"
                       data-operation-id="es4-<%= gruppo[:lettera] %>-<%= idx %>"
                       data-correct-answer="<%= item[:answer] %>"
                       class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent">
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

    <!-- Modal -->
    <%= render 'shared/operation_viewer', display: :modal, title: "Addizioni in colonna", color: "blue" %>
  </div>

  <!-- Footer con controlli -->
  <%= render 'shared/exercise_controls', color: 'orange' %>
</div>
