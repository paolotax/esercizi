<div class="max-w-6xl mx-auto bg-white dark:bg-gray-900 p-3 md:p-6 transition-colors duration-300"
     data-controller="exercise-checker text-toggle font-controls"
     data-text-toggle-target="content"
     data-font-controls-target="content">

  <%= render 'shared/page_header', pagina: @pagina %>

  <div class="space-y-6">

    <!-- Esercizi IMPARARE TUTTI (1 e 2) -->
    <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl border-3 border-yellow-400 dark:border-yellow-500">
      <div class="grid grid-cols-1 md:grid-cols-2 divide-y-2 md:divide-y-0 md:divide-x-2 divide-<%= @pagina.base_color %>-300">
        <!-- Esercizio 1: Completa la tabella -->
        <div class="md:pr-6">
          <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
            <%= imparare_tutti_badge(1) %>
            Completa la tabella indicando in modi diversi il valore della cifra sottolineata. Segui l'esempio.
          </p>

          <div class="overflow-x-auto">
            <table class="w-full border-collapse border-2 border-cyan-400 dark:border-cyan-600">
              <tbody>
                <!-- Esempio -->
                <tr>
                  <td class="p-2 border-2 border-cyan-400 dark:border-cyan-600 text-center font-bold whitespace-nowrap">4<span class="underline">5</span> 701</td>
                  <td class="p-2 border-2 border-cyan-400 dark:border-cyan-600 text-center font-bold text-cyan-600">5 uk</td>
                  <td class="p-2 border-2 border-cyan-400 dark:border-cyan-600 text-center font-bold text-cyan-600">5 × 1 000</td>
                  <td class="p-2 border-2 border-cyan-400 dark:border-cyan-600 text-center font-bold text-cyan-600 whitespace-nowrap">5 000</td>
                </tr>
                <% [
                  { num: "2<span class=\"underline\">8</span>8 940", answers: ["8 dak", "8 × 10 000", "80000"] },
                  { num: "<span class=\"underline\">4</span>53 107", answers: ["4 hk", "4 × 100 000", "400000"] },
                  { num: "19<span class=\"underline\">8</span> 540", answers: ["8 uk", "8 × 1 000", "8000"] }
                ].each do |row| %>
                  <tr>
                    <td class="p-2 border-2 border-cyan-400 dark:border-cyan-600 text-center font-bold whitespace-nowrap"><%= row[:num].html_safe %></td>
                    <% row[:answers].each do |ans| %>
                      <td class="p-2 border-2 border-cyan-400 dark:border-cyan-600 text-center bg-white dark:bg-gray-700">
                        <input type="text" data-correct-answer="<%= ans %>" class="w-full border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
                      </td>
                    <% end %>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Esercizio 2: Segna con X -->
        <div class="pt-6 md:pt-0 md:pl-6">
          <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
            <%= imparare_tutti_badge(2) %>
            Segna con una <span class="underline">X</span> le uguaglianze corrette. Sono tre in tutto.
          </p>

          <div class="space-y-3">
            <% [
              { text: "3 hk = 300 000", correct: true },
              { text: "6 uk 5 h 2 da 8 u = 60 528", correct: false },
              { text: "7 hk 9 dak 4 h = 790 400", correct: true },
              { text: "1 uk 5 da 8 hk 8 u = 1 588", correct: false },
              { text: "2 dak 7 uk 7 u = 27 007", correct: true }
            ].each_with_index do |item, idx| %>
              <div class="flex items-center gap-3">
                <span class="flex-1 <%= item[:correct] && idx == 0 ? 'font-bold' : '' %>"><%= item[:text] %></span>
                <% if item[:correct] && idx == 0 %>
                  <span class="w-8 h-8 flex items-center justify-center border-2 border-cyan-400 dark:border-cyan-600 font-bold text-cyan-600">X</span>
                <% else %>
                  <label class="relative w-8 h-8 flex items-center justify-center border-2 border-gray-300 cursor-pointer has-[:checked]:bg-cyan-300 has-[:checked]:border-cyan-500">
                    <input type="checkbox" data-correct-answer="<%= item[:correct] %>" class="absolute opacity-0">
                    <span class="hidden [:checked+&]:block font-bold">X</span>
                  </label>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Esercizio 3: Collega come nell'esempio -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(3) %>
        Collega come nell'esempio.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
        <!-- Gruppo 23 - Esempio (già risolto) -->
        <div data-controller="flower-matcher" data-flower-matcher-solved-value="true" class="relative">
          <svg data-flower-matcher-target="canvas" class="absolute inset-0 w-full h-full pointer-events-none z-10"></svg>
          <div class="flex justify-between">
            <div class="space-y-3">
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower"
                   data-flower-id="23-dak" data-pair="230000">23 decine di migliaia</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower"
                   data-flower-id="23-cent" data-pair="2300">23 centinaia</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower"
                   data-flower-id="23-uk" data-pair="23000">23 unità di migliaia</div>
            </div>
            <div class="space-y-3">
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower"
                   data-flower-id="ans-2300" data-pair="2300">2 300</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower"
                   data-flower-id="ans-23000" data-pair="23000">23 000</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower"
                   data-flower-id="ans-230000" data-pair="230000">230 000</div>
            </div>
          </div>
        </div>

        <!-- Gruppo 66 -->
        <div data-controller="flower-matcher" class="relative">
          <svg data-flower-matcher-target="canvas" class="absolute inset-0 w-full h-full pointer-events-none z-10"></svg>
          <div class="flex justify-between">
            <div class="space-y-3">
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="66-cent" data-pair="6600">66 centinaia</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="66-dak" data-pair="660000">66 decine di migliaia</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="66-dec" data-pair="660">66 decine</div>
            </div>
            <div class="space-y-3">
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="ans-660000" data-pair="660000">660 000</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="ans-6600" data-pair="6600">6 600</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="ans-660" data-pair="660">660</div>
            </div>
          </div>
        </div>

        <!-- Gruppo 84 -->
        <div data-controller="flower-matcher" class="relative">
          <svg data-flower-matcher-target="canvas" class="absolute inset-0 w-full h-full pointer-events-none z-10"></svg>
          <div class="flex justify-between">
            <div class="space-y-3">
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="84-cent" data-pair="8400">84 centinaia</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="84-dak" data-pair="840000">84 decine di migliaia</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="84-u" data-pair="84">84 unità</div>
            </div>
            <div class="space-y-3">
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="ans-84" data-pair="84">84</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="ans-8400" data-pair="8400">8 400</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="ans-840000" data-pair="840000">840 000</div>
            </div>
          </div>
        </div>

        <!-- Gruppo 125 -->
        <div data-controller="flower-matcher" class="relative">
          <svg data-flower-matcher-target="canvas" class="absolute inset-0 w-full h-full pointer-events-none z-10"></svg>
          <div class="flex justify-between">
            <div class="space-y-3">
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="125-dec" data-pair="1250">125 decine</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="125-uk" data-pair="125000">125 unità di migliaia</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="125-cent" data-pair="12500">125 centinaia</div>
            </div>
            <div class="space-y-3">
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="ans-125000" data-pair="125000">125 000</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="ans-1250" data-pair="1250">1 250</div>
              <div class="px-2 py-1 bg-white dark:bg-gray-700 border-2 border-cyan-400 dark:border-cyan-600 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/50 transition-colors text-center font-bold whitespace-nowrap"
                   data-flower-matcher-target="flower" data-action="click->flower-matcher#selectFlower"
                   data-flower-id="ans-12500" data-pair="12500">12 500</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Esercizio 4: Trova il numero misterioso -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(4) %>
        Trova il numero misterioso e colora il fiore che lo contiene.
      </p>

      <div class="space-y-4">
        <!-- Indovinello 1 -->
        <div>
          <p class="text-gray-700 dark:text-gray-300 mb-2">
            <span class="text-cyan-500">•</span>
            La cifra delle decine di migliaia è 6. Le cifre che lo compongono sono tutte diverse.
          </p>
          <div class="flex flex-wrap gap-3 justify-center">
            <% ["65096", "65769", "56078", "65721", "66788"].each do |num| %>
              <label class="relative px-4 py-2 border-2 border-cyan-200 rounded-full cursor-pointer has-[:checked]:bg-cyan-300 has-[:checked]:border-cyan-500 font-bold">
                <input type="radio" name="mystery1" data-correct-answer="<%= num == "65721" %>" class="absolute opacity-0">
                <span class="whitespace-nowrap"><%= num.to_i.to_s.reverse.gsub(/(\d{3})(?=\d)/, '\\1 ').reverse %></span>
              </label>
            <% end %>
          </div>
        </div>

        <!-- Indovinello 2 -->
        <div>
          <p class="text-gray-700 dark:text-gray-300 mb-2">
            <span class="text-cyan-500">•</span>
            La cifra delle centinaia è 3. La somma di tutte le sue cifre è uguale a 18.
          </p>
          <div class="flex flex-wrap gap-3 justify-center">
            <% ["701380", "112356", "31355", "343162", "65370"].each do |num| %>
              <label class="relative px-4 py-2 border-2 border-cyan-200 rounded-full cursor-pointer has-[:checked]:bg-cyan-300 has-[:checked]:border-cyan-500 font-bold">
                <input type="radio" name="mystery2" data-correct-answer="<%= num == "31355" %>" class="absolute opacity-0">
                <span class="whitespace-nowrap"><%= num.to_i.to_s.reverse.gsub(/(\d{3})(?=\d)/, '\\1 ').reverse %></span>
              </label>
            <% end %>
          </div>
        </div>

        <!-- Indovinello 3 -->
        <div>
          <p class="text-gray-700 dark:text-gray-300 mb-2">
            <span class="text-cyan-500">•</span>
            La cifra delle centinaia di migliaia è 5. La cifra delle centinaia è uguale a quella delle unità.
          </p>
          <div class="flex flex-wrap gap-3 justify-center">
            <% ["59474", "595447", "595744", "955474", "595474"].each do |num| %>
              <label class="relative px-4 py-2 border-2 border-cyan-200 rounded-full cursor-pointer has-[:checked]:bg-cyan-300 has-[:checked]:border-cyan-500 font-bold">
                <input type="radio" name="mystery3" data-correct-answer="<%= num == "595474" %>" class="absolute opacity-0">
                <span class="whitespace-nowrap"><%= num.to_i.to_s.reverse.gsub(/(\d{3})(?=\d)/, '\\1 ').reverse %></span>
              </label>
            <% end %>
          </div>
        </div>

        <!-- Indovinello 4 -->
        <div>
          <p class="text-gray-700 dark:text-gray-300 mb-2">
            <span class="text-cyan-500">•</span>
            La cifra delle unità di migliaia è 7. La differenza tra le cifre delle centinaia e delle decine è uguale a 4.
          </p>
          <div class="flex flex-wrap gap-3 justify-center">
            <% ["157943", "175953", "157953", "157853", "715733"].each do |num| %>
              <label class="relative px-4 py-2 border-2 border-cyan-200 rounded-full cursor-pointer has-[:checked]:bg-cyan-300 has-[:checked]:border-cyan-500 font-bold">
                <input type="radio" name="mystery4" data-correct-answer="<%= num == "175953" %>" class="absolute opacity-0">
                <span class="whitespace-nowrap"><%= num.to_i.to_s.reverse.gsub(/(\d{3})(?=\d)/, '\\1 ').reverse %></span>
              </label>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <%= render 'shared/exercise_controls' %>
  </div>
</div>
