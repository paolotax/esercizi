<%#
  Partial unificato per griglie di operazioni in colonna.
  Può gestire:
  - Singole addizioni o sottrazioni
  - Coppie operazione + prova (sottrazione + addizione per la prova)

  Parametri:
  - operations: array di hash con :type, :operands, :show_carry/:show_borrow
  - with_proof: se true, genera anche la prova per ogni operazione
  - proof_type: 'addition' per prova sottrazione (resto + sottraendo = minuendo)
                'subtraction' per prova addizione (somma - addendo = altro addendo) - non comune
%>

<div class="space-y-8">
  <% operations.each_with_index do |op, idx| %>
    <div class="operation-item" data-operation-index="<%= idx %>">
      <% if with_proof %>
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-6">
          <!-- Operazione principale -->
          <div class="main-operation" data-type="main">
            <% if op[:type] == 'subtraction' %>
              <% sottrazione = Sottrazione.new(
                   minuend: op[:operands][0],
                   subtrahend: op[:operands][1],
                   show_minuend_subtrahend: true,
                   show_borrow: op[:show_borrow] || false
                 ) %>
              <%= render partial: 'strumenti/sottrazioni/column_subtraction',
                         locals: { sottrazione: sottrazione, operation_id: "#{idx}_main" } %>
            <% else %>
              <% addizione = Addizione.new(
                   addends: op[:operands],
                   show_addends: true,
                   show_carry: op[:show_carry] || false
                 ) %>
              <%= render partial: 'strumenti/addizioni/column_addition',
                         locals: { addizione: addizione, operation_id: "#{idx}_main" } %>
            <% end %>
          </div>

          <div class="text-2xl font-bold text-cyan-600 rotate-90 md:rotate-0">→</div>

          <!-- Prova -->
          <div class="proof-operation" data-type="proof">
            <% if op[:type] == 'subtraction' %>
              <%# Prova della sottrazione: sottraendo + resto = minuendo %>
              <%# Primo addendo (sottraendo) mostrato, secondo (resto) e risultato (minuendo) vuoti %>
              <% minuend = op[:operands][0] %>
              <% subtrahend = op[:operands][1] %>
              <% result = minuend - subtrahend %>
              <% proof_addizione = Addizione.new(
                   addends: [subtrahend, result],
                   show_addend_indices: [0],
                   show_carry: op[:show_carry] || false
                 ) %>
              <%= render partial: 'strumenti/addizioni/column_addition',
                         locals: { addizione: proof_addizione, operation_id: "#{idx}_proof" } %>
            <% else %>
              <%# Prova dell'addizione: somma - addendo = altro addendo (proprietà commutativa) %>
              <% proof_addizione = Addizione.new(
                   addends: op[:operands].reverse,
                   show_addends: true,
                   show_carry: op[:show_carry] || false
                 ) %>
              <%= render partial: 'strumenti/addizioni/column_addition',
                         locals: { addizione: proof_addizione, operation_id: "#{idx}_proof" } %>
            <% end %>
          </div>
        </div>
      <% else %>
        <!-- Operazione singola senza prova -->
        <% if op[:type] == 'subtraction' %>
          <%
            title = op[:show_operands] == false ? "#{op[:operands][0]} - #{op[:operands][1]} =" : nil
            sottrazione = Sottrazione.new(
               minuend: op[:operands][0],
               subtrahend: op[:operands][1],
               title: title,
               show_minuend_subtrahend: op[:show_operands] != false,
               show_borrow: op[:show_borrow] || false
             )
          %>
          <%= render partial: 'strumenti/sottrazioni/column_subtraction',
                     locals: { sottrazione: sottrazione, operation_id: idx } %>
        <% else %>
          <%
            title = op[:show_operands] == false ? "#{op[:operands][0]} + #{op[:operands][1]} =" : nil
            addizione = Addizione.new(
               addends: op[:operands],
               title: title,
               show_addends: op[:show_operands] != false,
               show_carry: op[:show_carry] || false
             )
          %>
          <%= render partial: 'strumenti/addizioni/column_addition',
                     locals: { addizione: addizione, operation_id: idx } %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
