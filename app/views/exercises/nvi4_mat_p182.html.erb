<div class="max-w-6xl mx-auto bg-white dark:bg-gray-900 p-3 md:p-6 transition-colors duration-300"
     data-controller="exercise-checker text-toggle font-controls operation-viewer"
     data-text-toggle-target="content"
     data-font-controls-target="content">

  <%= render 'shared/page_header', pagina: @pagina %>

  <div class="space-y-6">

    <!-- Esercizio 1: IMPARARE TUTTI - Calcola a mente e collega -->
    <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl border-3 border-yellow-400 dark:border-yellow-500">
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= imparare_tutti_badge(1) %>
        Calcola a mente e collega ogni operazione al risultato corretto.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Colonna sinistra -->
        <div>
          <%= render 'shared/fill_list',
              color: "cyan",
              equals: true,
              container_class: "space-y-3",
              items: [
                { prefix: "350 – 140", answer: "210", width: "w-20" },
                { prefix: "856 – 234", answer: "622", width: "w-20" },
                { prefix: "8 588 – 1 545", answer: "7043", width: "w-20" },
                { prefix: "5 500 – 4 200", answer: "1300", width: "w-20" }
              ] %>
        </div>

        <!-- Colonna destra -->
        <div>
          <%= render 'shared/fill_list',
              color: "cyan",
              equals: true,
              container_class: "space-y-3",
              items: [
                { prefix: "6 667 – 523", answer: "6144", width: "w-20" },
                { prefix: "7 645 – 4 300", answer: "3345", width: "w-20" },
                { prefix: "8 619 – 1 505", answer: "7114", width: "w-20" },
                { prefix: "3 550 – 1 400", answer: "2150", width: "w-20" }
              ] %>
        </div>
      </div>
    </div>

    <!-- Esercizio 2: Esegui le sottrazioni in colonna -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(2) %>
        Esegui le sottrazioni in colonna e trascrivi i risultati.
      </p>

      <%
        es2_gruppi = [
          { lettera: "a", operazioni: [
            { op: "1644-238", answer: "1406" },
            { op: "6645-1836", answer: "4809" },
            { op: "6844-4755", answer: "2089" },
            { op: "48212-16345", answer: "31867" }
          ]},
          { lettera: "b", operazioni: [
            { op: "4590-3257", answer: "1333" },
            { op: "6500-1334", answer: "5166" },
            { op: "54000-1799", answer: "52201" },
            { op: "900000-854003", answer: "45997" }
          ]}
        ]
      %>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <% es2_gruppi.each do |gruppo| %>
          <%
            operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
              { operation: item[:op], targetId: "es2-#{gruppo[:lettera]}-#{idx}" }
            }
          %>
          <div class="p-3 bg-cyan-50 dark:bg-cyan-900/30 rounded-lg">
            <p class="text-gray-700 dark:text-gray-200 font-bold mb-2 flex items-center gap-2">
              <%= gruppo[:lettera] %>.
              <button type="button"
                      data-action="click->operation-viewer#openGroup"
                      data-operations='<%= operations_data.to_json %>'
                      data-type="sottrazione"
                      data-group="<%= gruppo[:lettera] %>"
                      class="p-1 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition print-hidden"
                      title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </button>
            </p>
            <ul class="space-y-2">
              <% gruppo[:operazioni].each_with_index do |item, idx| %>
                <li class="flex items-center gap-2 flex-wrap">
                  <span class="text-gray-700 dark:text-gray-200"><%= item[:op].gsub('-', ' − ') %> =</span>
                  <input type="text"
                         data-operation-id="es2-<%= gruppo[:lettera] %>-<%= idx %>"
                         data-correct-answer="<%= item[:answer] %>"
                         class="w-24 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Esercizio 3: Calcola in colonna sul quaderno. Poi fai la prova -->
    <div>
      <p class="font-bold text-gray-700 dark:text-gray-200 mb-4">
        <%= numero_esercizio_badge(3) %>
        Calcola in colonna sul quaderno. Poi fai la prova.
      </p>

      <%
        es3_gruppi = [
          { lettera: "a", operazioni: [
            { op: "67932-37945", answer: "29987" },
            { op: "10+37", answer: "47" },
            { op: "34860-18399", answer: "16461" },
            { op: "990215-481036", answer: "509179" },
            { op: "770321-182284", answer: "588037" }
          ]},
          { lettera: "b", operazioni: [
            { op: "560000-290305", answer: "269695" },
            { op: "87679-76506", answer: "11173" },
            { op: "86220-12319", answer: "73901" },
            { op: "507876-35023", answer: "472853" }
          ]}
        ]
      %>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <% es3_gruppi.each do |gruppo| %>
          <%
            operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
              { operation: item[:op], targetId: "es3-#{gruppo[:lettera]}-#{idx}" }
            }
          %>
          <div class="p-3 bg-cyan-50 dark:bg-cyan-900/30 rounded-lg">
            <p class="text-gray-700 dark:text-gray-200 font-bold mb-2 flex items-center gap-2">
              <%= gruppo[:lettera] %>.
              <button type="button"
                      data-action="click->operation-viewer#openGroup"
                      data-operations='<%= operations_data.to_json %>'
                      data-type="sottrazione"
                      data-group="<%= gruppo[:lettera] %>"
                      class="p-1 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition print-hidden"
                      title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </button>
            </p>
            <ul class="space-y-2">
              <% gruppo[:operazioni].each_with_index do |item, idx| %>
                <li class="flex items-center gap-2 flex-wrap">
                  <span class="text-gray-700 dark:text-gray-200"><%= item[:op].gsub('-', ' − ') %> =</span>
                  <input type="text"
                         data-operation-id="es3-<%= gruppo[:lettera] %>-<%= idx %>"
                         data-correct-answer="<%= item[:answer] %>"
                         class="w-24 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent dark:text-white">
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>

      <!-- Box prova della sottrazione -->
      <div class="mt-6 p-4 bg-cyan-50 dark:bg-cyan-900 rounded-lg border-2 border-cyan-400 dark:border-cyan-600">
        <p class="font-bold text-cyan-600 dark:text-cyan-400 mb-3">Prova della sottrazione</p>
        <div class="flex justify-center">
          <%= image_tag "nvi4_mat/p182/p182_01.jpg", class: "max-w-xs h-auto dark:bg-white dark:rounded-lg dark:p-1", alt: "Prova della sottrazione" %>
        </div>
      </div>
    </div>

    <%= render 'shared/operation_viewer' %>
    <%= render 'shared/exercise_controls' %>
  </div>
</div>
