<% content_for :titolo, "#{@pagina.titolo} - #{@pagina.numero}" %>

<div class="max-w-7xl mx-auto p-3 md:p-6 bg-white dark:bg-gray-900 text-black dark:text-white transition-colors duration-300" data-controller="exercise-checker page-viewer text-toggle font-controls" data-page-viewer-image-url-value="<%= asset_path('bus3_mat/p047/page.png') %>" data-text-toggle-target="content" data-font-controls-target="content">
  <!-- Header -->
  <%= render 'shared/page_header', pagina: @pagina %>

  <!-- Parte teorica: Moltiplicazioni con una cifra -->
  <div class="bg-[#C7EAFB] dark:bg-cyan-900/40 p-4 md:p-6 -ml-3 md:-ml-0 -mr-3 md:mr-0 mb-8">
    <p class="text-gray-800 dark:text-gray-200 mb-6">
      <strong class="text-red-500">•</strong> Osserva come si eseguono le moltiplicazioni in colonna.
    </p>

    <!-- Sezione: SENZA CAMBIO -->
    <h3 class="text-red-500 mb-4"><strong>•</strong> SENZA CAMBIO</h3>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <div class="flex items-center gap-4">
        <%= image_tag "bus3_mat/p047/p47_1.jpg",
            alt: "Moltiplicazione senza cambio - passo 1",
            class: "max-w-full dark:bg-white dark:rounded-lg dark:p-2" %>
        <p class="text-gray-700 dark:text-gray-200">
          Prima moltiplica le <span class="text-cyan-500 font-bold">unità</span> per le <span class="text-cyan-500 font-bold">unità</span>.
        </p>
      </div>

      <div class="flex items-center gap-4">
        <%= image_tag "bus3_mat/p047/p47_2.jpg",
            alt: "Moltiplicazione senza cambio - passo 2",
            class: "max-w-full dark:bg-white dark:rounded-lg dark:p-2" %>
        <p class="text-gray-700 dark:text-gray-200">
          Dopo moltiplica le <span class="text-cyan-500 font-bold">unità</span> per le <span class="text-red-500 font-bold">decine</span>.
        </p>
      </div>
    </div>

    <!-- Sezione: CON IL CAMBIO -->
    <h3 class="text-red-500 mb-4 mt-8"><strong>•</strong> CON IL CAMBIO</h3>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="flex items-center gap-4">
        <%= image_tag "bus3_mat/p047/p47_3.jpg",
            alt: "Moltiplicazione con cambio - passo 1",
            class: "max-w-full dark:bg-white dark:rounded-lg dark:p-2" %>
        <p class="text-gray-700 dark:text-gray-200">
          Moltiplica le <span class="text-cyan-500 font-bold">unità</span> per le <span class="text-cyan-500 font-bold">unità</span>.<br>
          Scrivi <span class="text-cyan-500 font-bold">2</span> sotto le <span class="text-cyan-500 font-bold">unità</span> e <span class="text-cyan-500 font-bold">+1</span> sopra le
          <span class="text-red-500 font-bold">decine</span>.
        </p>
      </div>

      <div class="flex items-center gap-4">
        <%= image_tag "bus3_mat/p047/p47_4.jpg",
            alt: "Moltiplicazione con cambio - passo 2",
            class: "max-w-full dark:bg-white dark:rounded-lg dark:p-2" %>
        <p class="text-gray-700 dark:text-gray-200">
          Moltiplica le <span class="text-cyan-500 font-bold">unità</span> per
          le <span class="text-red-500 font-bold">decine</span> e aggiungi <span class="text-cyan-500 font-bold">+1</span> al risultato.
        </p>
      </div>

      <div class="flex items-center gap-4">
        <%= image_tag "bus3_mat/p047/p47_5.jpg",
            alt: "Moltiplicazione con cambio - passo 3",
            class: "max-w-full dark:bg-white dark:rounded-lg dark:p-2" %>
        <p class="text-gray-700 dark:text-gray-200">
          Moltiplica le <span class="text-cyan-500 font-bold">unità</span> per le <span class="text-green-500 font-bold">centinaia</span>.
        </p>
      </div>
    </div>
  </div>

  <!-- Esercizio 1: Calcola in colonna (con modal) -->
  <div class="p-4 md:p-8 mb-8" data-controller="operation-viewer">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">
        1
      </div>
      <p class="text-gray-700 dark:text-gray-200">
        Calcola in colonna sul quaderno.
      </p>
    </div>

    <%
      es1_gruppi = [
        { lettera: "a", colore: "orange", titolo: "Senza cambio", operazioni: [
          { op: "122x4", answer: "488" },
          { op: "221x3", answer: "663" },
          { op: "110x6", answer: "660" },
          { op: "324x2", answer: "648" },
          { op: "320x3", answer: "960" },
          { op: "201x4", answer: "804" }
        ]},
        { lettera: "b", colore: "blue", titolo: "Con un cambio", operazioni: [
          { op: "126x3", answer: "378" },
          { op: "104x8", answer: "832" },
          { op: "145x2", answer: "290" },
          { op: "136x2", answer: "272" },
          { op: "180x2", answer: "360" },
          { op: "190x4", answer: "760" }
        ]},
        { lettera: "c", colore: "green", titolo: "Con più cambi", operazioni: [
          { op: "123x5", answer: "615" },
          { op: "124x7", answer: "868" },
          { op: "146x4", answer: "584" }
        ]}
      ]
    %>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 items-start">
      <% es1_gruppi.each do |gruppo| %>
        <%
          operations_data = gruppo[:operazioni].each_with_index.map { |item, idx|
            { operation: item[:op], targetId: "es1-#{gruppo[:lettera]}-#{idx}" }
          }
        %>
        <div class="bg-<%= gruppo[:colore] %>-50 dark:bg-<%= gruppo[:colore] %>-900/30 p-4 rounded-lg border-2 border-transparent hover:border-<%= gruppo[:colore] %>-400 transition">
          <p class="font-bold text-<%= gruppo[:colore] %>-600 dark:text-<%= gruppo[:colore] %>-400 mb-3 flex items-center gap-2">
            <%= gruppo[:lettera] %>. <%= gruppo[:titolo] %>
            <button type="button"
                    data-action="click->operation-viewer#openGroup"
                    data-operations='<%= operations_data.to_json %>'
                    data-type="moltiplicazione"
                    data-layout="column"
                    data-display="modal"
                    data-group="<%= gruppo[:lettera] %>"
                    class="p-1 text-gray-400 hover:text-<%= gruppo[:colore] %>-600 dark:hover:text-<%= gruppo[:colore] %>-400 transition print-hidden"
                    title="Apri gruppo <%= gruppo[:lettera] %> nella calcolatrice">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
            </button>
          </p>
          <ul class="space-y-2">
            <% gruppo[:operazioni].each_with_index do |item, idx| %>
              <li class="flex items-center gap-2 flex-wrap dark:text-white">
                <span><%= item[:op].gsub('x', ' × ') %> =</span>
                <input type="text"
                       data-operation-id="es1-<%= gruppo[:lettera] %>-<%= idx %>"
                       data-correct-answer="<%= item[:answer] %>"
                       class="w-16 border-b-2 border-dotted border-gray-400 dark:border-gray-500 text-center font-bold bg-transparent">
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

    <!-- Modal -->
    <%= render 'shared/operation_viewer', display: :modal, title: "Moltiplicazioni in colonna", color: "green" %>

    <div class="mt-6 text-right">
      <span class="text-gray-600 dark:text-gray-400">Quaderno →</span> <%= link_to "p. 150", pagina_path("bus3_mat_p150"), class: "text-cyan-600 dark:text-cyan-400 font-bold hover:underline" %>
    </div>
  </div>

  <!-- Footer con controlli -->
  <%= render 'shared/exercise_controls' %>
</div>
