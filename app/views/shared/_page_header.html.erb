<%
  # Estrae dati da oggetto Pagina o usa parametri manuali
  if local_assigns[:pagina].is_a?(Pagina)
    pagina_obj = local_assigns[:pagina]
    numero = pagina_obj.numero
    sottotitolo = pagina_obj.sottotitolo || pagina_obj.disciplina.nome.upcase
    titolo = pagina_obj.titolo
    colore = pagina_obj.base_color || "blue"
    libro = pagina_obj.slug.split("_p").first
    pagina_str = "p#{ pagina_obj.numero.to_s.rjust(3, "0") }"
  else
    # Usa parametri manuali
    pagina_str = local_assigns[:pagina_str] || local_assigns[:pagina] || "p000"
  end

  # Mapping colori
  colors = {
    "purple" => { badge: "bg-purple-500", title: "text-purple-600 dark:text-purple-400", numero: "bg-purple-600", numero_hover: "hover:bg-purple-700" },
    "blue" => { badge: "bg-blue-500", title: "text-blue-600 dark:text-blue-400", numero: "bg-blue-600", numero_hover: "hover:bg-blue-700" },
    "cyan" => { badge: "bg-cyan-500", title: "text-cyan-600 dark:text-cyan-400", numero: "bg-cyan-600", numero_hover: "hover:bg-cyan-700" },
    "green" => { badge: "bg-green-500", title: "text-green-600 dark:text-green-400", numero: "bg-green-600", numero_hover: "hover:bg-green-700" },
    "orange" => { badge: "bg-orange-500", title: "text-orange-600 dark:text-orange-400", numero: "bg-orange-600", numero_hover: "hover:bg-orange-700" },
    "red" => { badge: "bg-red-500", title: "text-red-600 dark:text-red-400", numero: "bg-red-600", numero_hover: "hover:bg-red-700" },
    "pink" => { badge: "bg-pink-500", title: "text-pink-600 dark:text-pink-400", numero: "bg-pink-600", numero_hover: "hover:bg-pink-700" },
    "yellow" => { badge: "bg-yellow-500", title: "text-yellow-600 dark:text-yellow-400", numero: "bg-yellow-600", numero_hover: "hover:bg-yellow-700" }
  }

  badge_color = colors.dig(colore, :badge) || "bg-blue-500"
  title_color = colors.dig(colore, :title) || "text-blue-600 dark:text-blue-400"
  numero_bg = colors.dig(colore, :numero) || "bg-blue-600"
  numero_hover = colors.dig(colore, :numero_hover) || "hover:bg-blue-700"
  image_path = "#{ libro }/#{ pagina_str }/page.png"
%>

<% content_for :header do %>
  <%= back_link_to "Indietro", 'javascript:history.back()', "keydown.esc@document->hotkey#goBack" %>

  <!-- Dark mode toggle -->
  <button type="button"
          data-controller="dark-mode"
          data-action="click->dark-mode#toggle"
          class="absolute top-0 right-2 sm:right-4 btn-press flex items-center justify-center bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl hover:bg-white dark:hover:bg-gray-700 text-coral dark:text-coral font-bold p-2.5 md:p-3 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105">
    <!-- Sun icon (shown in dark mode) -->
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
    </svg>
    <!-- Moon icon (shown in light mode) -->
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
    </svg>
  </button>
<% end %>

<div class="mb-8" data-controller="page-viewer" data-page-viewer-image-url-value="<%= asset_path(image_path) %>">
  <div class="flex items-start sm:items-center justify-between gap-4 mb-4">
    <div class="flex flex-col-reverse sm:flex-row items-start sm:items-center gap-2 sm:gap-4">
      <div class="<%= badge_color %> text-white text-md sm:text-xl px-2 sm:px-4 py-1.5 sm:py-2 rounded-lg font-bold">
        <%= sottotitolo %>
      </div>
      <h1 class="text-2xl sm:text-3xl font-bold <%= title_color %>"><%= titolo %></h1>
    </div>
    <div class="flex-shrink-0 <%= numero_bg %> <%= numero_hover %> text-white rounded-full w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center font-bold text-lg sm:text-xl cursor-pointer transition-colors"
         data-action="click->page-viewer#openOriginal"
         title="Clicca per vedere la pagina originale">
      <%= numero %>
    </div>
  </div>
</div>
