<%
  # Parametri:
  # - operation: stringa con l'operazione (es: "487 - 258")
  # - numbers: array di 2 numeri interi (alternativo a operation)
  # - title: titolo dell'operazione (opzionale)
  # - show_exercise: se true, mostra esercizio completo (prestiti + risultato) da compilare (default: true)
  # - show_minuend_subtrahend: se true, mostra solo minuendo e sottraendo pre-compilati (default: false)
  # - show_solution: se true, mostra la soluzione completa (prestiti + risultato) pre-compilata (default: false)
  # - show_toolbar: se true, mostra la toolbar con i pulsanti (default: false)
  # - show_borrow: se true, mostra la riga dei prestiti (default: true)

  title = local_assigns.fetch(:title, nil)
  show_exercise = local_assigns.fetch(:show_exercise, true)
  show_minuend_subtrahend = local_assigns.fetch(:show_minuend_subtrahend, false)
  show_solution = local_assigns.fetch(:show_solution, false)
  show_toolbar = local_assigns.fetch(:show_toolbar, false)
  show_borrow = local_assigns.fetch(:show_borrow, true)

  # Parse operation string se fornita
  if defined?(operation) && operation.present?
    numbers = operation.gsub(/\s+/, '').split(/[-=]/).map(&:to_i).reject(&:zero?)
  end

  # Fallback a valori di default
  numbers ||= [0, 0]
  minuend = numbers[0] || 0
  subtrahend = numbers[1] || 0

  # Calcola il risultato
  result = minuend - subtrahend

  # Determina il numero massimo di cifre
  max_digits = [minuend, subtrahend, result].compact.max.to_s.length

  # Converti ogni numero in array di cifre (da sinistra a destra)
  minuend_str = minuend.to_s
  minuend_padding = max_digits - minuend_str.length
  minuend_digits = ([''] * minuend_padding) + minuend_str.chars

  subtrahend_str = subtrahend.to_s
  subtrahend_padding = max_digits - subtrahend_str.length
  subtrahend_digits = ([''] * subtrahend_padding) + subtrahend_str.chars

  result_str = result.to_s
  result_padding = max_digits - result_str.length
  result_digits = ([''] * result_padding) + result_str.chars

  # Calcola i prestiti per ogni colonna (da destra a sinistra)
  # Sopra la cifra che presta, scrivo il nuovo valore (es: 8-1=7)
  # Sotto, la cifra originale viene barrata
  borrows = Array.new(max_digits, '')
  crossed_out = Array.new(max_digits, false)
  borrowed_minuend = minuend_digits.map { |d| d.present? ? d.to_i : 0 }

  (max_digits - 1).downto(0) do |col_idx|
    minuend_digit = borrowed_minuend[col_idx]
    subtrahend_digit = subtrahend_digits[col_idx].present? ? subtrahend_digits[col_idx].to_i : 0

    # Se minuendo < sottraendo, serve un prestito
    if minuend_digit < subtrahend_digit && col_idx > 0
      # Prendi in prestito dalla colonna precedente (a sinistra)
      borrowed_minuend[col_idx] += 10
      borrowed_minuend[col_idx - 1] -= 1
      # Marca la cifra che presta come barrata
      crossed_out[col_idx - 1] = true
      # Sopra la cifra che presta, scrivo il nuovo valore
      borrows[col_idx - 1] = borrowed_minuend[col_idx - 1].to_s
    end
  end

  # Etichette delle colonne (da sinistra a destra: piÃ¹ significativo a meno significativo)
  labels = []
  labels_colors = []

  if max_digits >= 7
    labels << 'M'
    labels_colors << 'text-purple-600'
  end
  if max_digits >= 6
    labels << 'hk'
    labels_colors << 'text-orange-600'
  end
  if max_digits >= 5
    labels << 'dak'
    labels_colors << 'text-yellow-600'
  end
  if max_digits >= 4
    labels << 'uk'
    labels_colors << 'text-pink-600'
  end
  if max_digits >= 3
    labels << 'h'
    labels_colors << 'text-green-600'
  end
  if max_digits >= 2
    labels << 'da'
    labels_colors << 'text-red-500'
  end
  labels << 'u'
  labels_colors << 'text-blue-600'

  # Padding per avere sempre max_digits etichette
  while labels.length < max_digits
    labels.unshift('')
    labels_colors.unshift('text-gray-400')
  end

  # Usa CSS grid-template-columns invece di classi Tailwind dinamiche
  grid_style = "display: grid; grid-template-columns: repeat(#{max_digits}, 4rem); gap: 0;"
%>

<style>
  /* Barratura doppia diagonale per le cifre barrate (come una X) usando background-image */
  [data-column-subtraction-target="input"].line-through {
    background-image:
      linear-gradient(to bottom right, transparent calc(50% - 1px), #000000 calc(50% - 1px), #000000 calc(50% + 1px), transparent calc(50% + 1px)),
      linear-gradient(to bottom left, transparent calc(50% - 1px), #000000 calc(50% - 1px), #000000 calc(50% + 1px), transparent calc(50% + 1px));
    background-size: 50% 50%;
    background-position: center;
    background-repeat: no-repeat;
  }
</style>

<div class="text-center">
  <% if title.present? %>
    <div class="text-xl font-bold mb-4"><%= title %></div>
  <% end %>

  <div class="flex items-start justify-center gap-2">
    <div class="inline-block border-4 border-blue-400 rounded-lg" data-controller="column-subtraction">

      <!-- Header con le etichette delle colonne -->
      <div class="border-b-2 border-gray-300 flex">
        <div class="w-8"></div>
        <div style="<%= grid_style %>">
          <% labels.each_with_index do |label, idx| %>
            <div class="text-center <%= labels_colors[idx] %> font-bold <%= 'border-r-2 border-gray-300' unless idx == labels.length - 1 %> py-2 text-sm">
              <%= label %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Riga dei prestiti -->
      <% if show_borrow %>
      <div class="bg-red-50 border-b border-gray-200 flex">
        <div class="w-8"></div>
        <div style="<%= grid_style %>">
          <% borrows.each_with_index do |borrow, idx| %>
            <input type="text"
                   class="text-center text-sm font-bold <%= labels_colors[idx] %> <%= idx == max_digits - 1 ? 'bg-white' : 'bg-red-50' %> <%= 'border-r-2 border-gray-300' unless idx == max_digits - 1 %>"
                   data-column-subtraction-target="carry"
                   data-correct-answer="<%= borrow %>"
                   maxlength="1"
                   placeholder=""
                   <% if show_solution && borrow.present? %>value="<%= borrow %>"<% end %>
                   <% if idx == max_digits - 1 %>disabled<% end %>
                   style="height: 2rem;">
          <% end %>
        </div>
      </div>
      <% end %>

      <!-- Riga del minuendo -->
      <div class="border-b border-gray-200 flex" style="height: 4rem;">
        <div class="w-8 flex items-center justify-center"></div>
        <div style="<%= grid_style %>">
          <% minuend_digits.each_with_index do |digit, idx| %>
            <input type="text"
                   class="text-center text-2xl font-bold <%= 'border-r-2 border-gray-300' unless idx == minuend_digits.length - 1 %> <%= 'line-through' if crossed_out[idx] && show_solution %>"
                   data-column-subtraction-target="input"
                   data-correct-answer="<%= digit %>"
                   data-crossed-out="<%= crossed_out[idx] %>"
                   maxlength="1"
                   placeholder="."
                   <% if (show_minuend_subtrahend || show_solution) && digit.present? %>value="<%= digit %>"<% end %>>
          <% end %>
        </div>
      </div>

      <!-- Riga del sottraendo -->
      <div class="border-b border-gray-200 flex" style="height: 4rem;">
        <div class="w-8 flex items-center justify-center text-2xl font-bold text-blue-600">-</div>
        <div style="<%= grid_style %>">
          <% subtrahend_digits.each_with_index do |digit, idx| %>
            <input type="text"
                   class="text-center text-2xl font-bold <%= 'border-r-2 border-gray-300' unless idx == subtrahend_digits.length - 1 %>"
                   data-column-subtraction-target="input"
                   data-correct-answer="<%= digit %>"
                   maxlength="1"
                   placeholder="."
                   <% if (show_minuend_subtrahend || show_solution) && digit.present? %>value="<%= digit %>"<% end %>>
          <% end %>
        </div>
      </div>

      <!-- Riga del risultato -->
      <div class="border-t-4 border-gray-500 flex" style="height: 4rem;">
        <div class="w-8 flex items-center justify-center text-2xl font-bold text-blue-600">=</div>
        <div style="<%= grid_style %>">
          <% result_digits.each_with_index do |digit, idx| %>
            <input type="text"
                   class="text-center text-2xl font-bold <%= 'border-r-2 border-gray-300' unless idx == result_digits.length - 1 %>"
                   data-column-subtraction-target="result"
                   data-correct-answer="<%= digit %>"
                   maxlength="1"
                   placeholder="."
                   <% if show_solution && digit.present? %>value="<%= digit %>"<% end %>>
          <% end %>
        </div>
      </div>

    </div>
  </div>

  <!-- Toolbar con pulsanti -->
  <% if show_toolbar %>
  <div class="print-hidden flex justify-center gap-4 mt-6">
    <!-- Cancella -->
    <button type="button"
            class="w-14 h-14 rounded-full bg-gray-500 hover:bg-gray-600 text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-110 flex items-center justify-center"
            onclick="clearSubtractionGrid(this)"
            title="Cancella">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    </button>

    <!-- Mostra Numeri -->
    <button type="button"
            class="w-14 h-14 rounded-full bg-blue-500 hover:bg-blue-600 text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-110 flex items-center justify-center"
            onclick="showNumbers(this)"
            title="Mostra Numeri">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
    </button>

    <!-- Mostra Risultato -->
    <button type="button"
            class="w-14 h-14 rounded-full bg-green-500 hover:bg-green-600 text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-110 flex items-center justify-center"
            onclick="showSubtractionResult(this)"
            title="Mostra Risultato">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </button>

    <!-- Verifica -->
    <button type="button"
            class="w-14 h-14 rounded-full bg-purple-500 hover:bg-purple-600 text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-110 flex items-center justify-center"
            onclick="verifySubtractionAnswers(this)"
            title="Verifica">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
      </svg>
    </button>
  </div>
  <% end %>
</div>

<script>
function clearSubtractionGrid(button) {
  const grid = button.closest('.text-center').querySelector('[data-controller="column-subtraction"]');
  const inputs = grid.querySelectorAll('input');
  inputs.forEach(input => {
    input.value = '';
    input.classList.remove('bg-green-100', 'bg-red-100', 'line-through');
  });
}

function showNumbers(button) {
  const grid = button.closest('.text-center').querySelector('[data-controller="column-subtraction"]');
  const inputs = grid.querySelectorAll('[data-column-subtraction-target="input"]');
  inputs.forEach(input => {
    const correctAnswer = input.getAttribute('data-correct-answer');
    if (correctAnswer) {
      input.value = correctAnswer;
    }
  });
}

function showSubtractionResult(button) {
  const grid = button.closest('.text-center').querySelector('[data-controller="column-subtraction"]');

  // Mostra i prestiti
  const borrows = grid.querySelectorAll('[data-column-subtraction-target="carry"]');
  borrows.forEach(input => {
    const correctAnswer = input.getAttribute('data-correct-answer');
    if (correctAnswer) {
      input.value = correctAnswer;
    }
  });

  // Mostra i risultati
  const results = grid.querySelectorAll('[data-column-subtraction-target="result"]');
  results.forEach(input => {
    const correctAnswer = input.getAttribute('data-correct-answer');
    if (correctAnswer) {
      input.value = correctAnswer;
    }
  });

  // Applica line-through alle cifre del minuendo che hanno prestato
  const inputs = grid.querySelectorAll('[data-column-subtraction-target="input"]');
  inputs.forEach(input => {
    const crossedOut = input.getAttribute('data-crossed-out') === 'true';
    if (crossedOut) {
      input.classList.add('line-through');
    }
  });
}

function verifySubtractionAnswers(button) {
  const grid = button.closest('.text-center').querySelector('[data-controller="column-subtraction"]');

  // Raccogli tutti gli input: prestiti, numeri e risultati
  const borrows = Array.from(grid.querySelectorAll('[data-column-subtraction-target="carry"]'));
  const inputs = Array.from(grid.querySelectorAll('[data-column-subtraction-target="input"]'));
  const results = Array.from(grid.querySelectorAll('[data-column-subtraction-target="result"]'));

  const allInputs = [...borrows, ...inputs, ...results];

  let correct = 0;
  let total = 0;

  allInputs.forEach(input => {
    const correctAnswer = input.getAttribute('data-correct-answer');
    const userAnswer = input.value.trim();

    // Salta le celle vuote che devono rimanere vuote
    if (correctAnswer === '' && userAnswer === '') {
      return;
    }

    total++;

    // Rimuovi colori precedenti
    input.classList.remove('bg-green-100', 'bg-red-100');

    if (userAnswer === correctAnswer) {
      input.classList.add('bg-green-100');
      correct++;
    } else if (userAnswer !== '') {
      input.classList.add('bg-red-100');
    }
  });

  // Mostra messaggio dettagliato
  const message = correct === total
    ? `ðŸŽ‰ Perfetto! ${correct}/${total} risposte corrette!`
    : `ðŸ“Š ${correct}/${total} risposte corrette. Continua cosÃ¬!`;

  alert(message);
}
</script>
