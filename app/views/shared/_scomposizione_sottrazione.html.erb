<%
  a = local_assigns[:a] || 0
  b = local_assigns[:b] || 0
  color = local_assigns[:color] || "cyan"

  a_dec = (a / 10) * 10
  a_uni = a % 10
  b_dec = (b / 10) * 10
  b_uni = b % 10

  diff_dec = a_dec - b_dec
  diff_uni = a_uni - b_uni
  risultato = a - b

  uid = SecureRandom.hex(4)
%>

<div class="inline-block font-sans">
  <table class="border-collapse text-center">
    <!-- Riga 1: Operazione originale -->
    <tr class="font-bold">
      <td class="px-1 text-<%= color %>-600"><%= a %></td>
      <td class="px-1">−</td>
      <td class="px-1 text-<%= color %>-600"><%= b %></td>
      <td class="px-1">=</td>
      <td></td>
    </tr>

    <!-- Frecce scomposizione -->
    <tr>
      <td class="h-5">
        <svg width="100%" height="18" viewBox="0 0 30 18" preserveAspectRatio="xMidYMid meet">
          <defs>
            <marker id="arr-<%= uid %>" markerWidth="4" markerHeight="4" refX="2" refY="2" orient="auto">
              <path d="M0,0 L4,2 L0,4 Z" fill="currentColor"/>
            </marker>
          </defs>
          <line x1="15" y1="0" x2="15" y2="14" stroke="currentColor" stroke-width="1.5" marker-end="url(#arr-<%= uid %>)"/>
        </svg>
      </td>
      <td></td>
      <td class="h-5">
        <svg width="100%" height="18" viewBox="0 0 30 18" preserveAspectRatio="xMidYMid meet">
          <line x1="15" y1="0" x2="15" y2="14" stroke="currentColor" stroke-width="1.5" marker-end="url(#arr-<%= uid %>)"/>
        </svg>
      </td>
      <td></td>
      <td></td>
    </tr>

    <!-- Riga 2: Scomposizione -->
    <tr>
      <td class="px-1">(<span class="text-<%= color %>-600"><%= a_dec %></span><span class="text-gray-400 dark:text-gray-400">+</span><%= a_uni %>)</td>
      <td class="px-1">−</td>
      <td class="px-1">(<span class="text-<%= color %>-600"><%= b_dec %></span><span class="text-gray-400 dark:text-gray-400">+</span><%= b_uni %>)</td>
      <td class="px-1">=</td>
      <td></td>
    </tr>

    <!-- Frecce incrociate (solo 2) -->
    <tr>
      <td colspan="3" class="h-6">
        <svg width="100%" height="24" viewBox="0 0 100 24" preserveAspectRatio="xMidYMid meet">
          <!-- Freccia da unità di a verso destra (incrocio) -->
          <line x1="30" y1="2" x2="70" y2="20" stroke="currentColor" class="text-gray-700 dark:text-gray-300" stroke-width="2" marker-end="url(#arr-<%= uid %>)"/>
          <!-- Freccia da decine di b verso sinistra (incrocio) -->
          <line x1="70" y1="2" x2="30" y2="20" stroke="currentColor" class="text-gray-700 dark:text-gray-300" stroke-width="2" marker-end="url(#arr-<%= uid %>)"/>
        </svg>
      </td>
      <td></td>
      <td></td>
    </tr>

    <!-- Riga 3: Raggruppato -->
    <tr>
      <td class="px-1">(<span class="text-<%= color %>-600"><%= a_dec %></span><span class="text-gray-400 dark:text-gray-400">−</span><span class="text-<%= color %>-600"><%= b_dec %></span>)</td>
      <td class="px-1">+</td>
      <td class="px-1">(<%= a_uni %><span class="text-gray-400 dark:text-gray-400">−</span><%= b_uni %>)</td>
      <td class="px-1">=</td>
      <td></td>
    </tr>

    <!-- Parentesi associativa -->
    <tr>
      <td class="h-5">
        <svg width="100%" height="20" viewBox="0 0 50 20" preserveAspectRatio="xMidYMid meet" class="text-gray-700 dark:text-gray-300">
          <path d="M 5 2 L 5 8 L 45 8 L 45 2" stroke="currentColor" stroke-width="1.5" fill="none"/>
          <path d="M 25 8 L 25 18" stroke="currentColor" stroke-width="1.5" fill="none" marker-end="url(#arr-<%= uid %>)"/>
        </svg>
      </td>
      <td></td>
      <td class="h-5">
        <svg width="100%" height="20" viewBox="0 0 50 20" preserveAspectRatio="xMidYMid meet" class="text-gray-700 dark:text-gray-300">
          <path d="M 5 2 L 5 8 L 45 8 L 45 2" stroke="currentColor" stroke-width="1.5" fill="none"/>
          <path d="M 25 8 L 25 18" stroke="currentColor" stroke-width="1.5" fill="none" marker-end="url(#arr-<%= uid %>)"/>
        </svg>
      </td>
      <td></td>
      <td></td>
    </tr>

    <!-- Riga 4: Risultato -->
    <tr class="font-bold">
      <td class="px-1 text-<%= color %>-600"><%= diff_dec %></td>
      <td class="px-1">+</td>
      <td class="px-1"><%= diff_uni %></td>
      <td class="px-1">=</td>
      <td class="px-1 text-<%= color %>-600"><%= risultato %></td>
    </tr>
  </table>
</div>
