<!-- Overlay per mobile -->
<div id="sidebar-overlay" 
     class="print-hidden fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"
     data-sidebar-target="overlay"
     data-action="click->sidebar#close"></div>

<aside id="sidebar-nav"
       class="print-hidden w-80 bg-white border-r border-gray-200 overflow-y-auto transition-all duration-300 fixed md:static inset-y-0 left-0 z-50 md:z-auto"
       data-sidebar-target="sidebar"
       data-controller="sidebar-nav"
       data-turbo-permanent
       data-turbo-permanent-scroll>

  <!-- Header -->
  <div class="p-4 border-b border-gray-200">
    <div class="flex items-center justify-center mb-4">
      <!-- Home button -->
      <%= link_to root_path,
          data: { turbo_frame: "_top" },
          class: "flex items-center justify-center hover:opacity-80 transition" do %>
        <%= image_tag "giunti_scuola.svg", alt: "Giunti Scuola", class: "h-12 w-auto" %>
      <% end %>
    </div>
    <h2 class="text-lg font-bold text-gray-800 text-center">Libri di Testo</h2>
  </div>

  <!-- Menu Content -->
  <nav class="p-4">
    <div class="space-y-1">
      <% Volume.all.includes(:corso, discipline: :pagine).each do |volume| %>
        <div class="volume-item">
          <!-- Volume -->
          <button class="w-full flex items-center gap-2 p-3 rounded-lg hover:bg-purple-50 transition text-left group"
                  data-action="click->sidebar-nav#toggle"
                  data-sidebar-item-id="volume-<%= volume.id %>">
            <svg class="toggle-icon w-4 h-4 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <div class="flex-1">
              <div class="text-xs text-gray-500"><%= volume.corso.nome %></div>
              <div class="font-semibold text-gray-900"><%= volume.nome %></div>
              <% if volume.classe %>
                <div class="text-xs text-gray-500">Classe <%= volume.classe %></div>
              <% end %>
            </div>
          </button>

          <!-- Discipline (collassabile) -->
          <div class="sidebar-children ml-4 hidden" 
               data-sidebar-children-id="volume-<%= volume.id %>"
               style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
            <% volume.discipline.each do |disciplina| %>
              <div class="disciplina-item mt-1">
                <!-- Disciplina -->
                <button class="w-full flex items-center gap-2 p-2 rounded-lg hover:bg-indigo-50 transition text-left group"
                        data-action="click->sidebar-nav#toggle"
                        data-sidebar-item-id="disciplina-<%= disciplina.id %>">
                  <svg class="toggle-icon w-3 h-3 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-700"
                         style="<%= "color: #{disciplina.colore};" if disciplina.colore.present? %>">
                      <%= disciplina.nome %>
                    </div>
                    <div class="text-xs text-gray-500"><%= pluralize(disciplina.pagine.count, "pagina", "pagine") %></div>
                  </div>
                </button>

                <!-- Pagine (collassabile) -->
                <div class="sidebar-children ml-4 hidden"
                     data-sidebar-children-id="disciplina-<%= disciplina.id %>"
                     style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
                  <% disciplina.pagine.each do |pagina| %>
                    <%= link_to pagina_path(pagina.slug),
                                class: "flex items-center gap-2 p-2 rounded-lg hover:bg-gray-100 transition group mt-1" do %>
                      <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold"
                           style="background-color: <%= disciplina.colore || '#6B7280' %>">
                        <%= pagina.numero %>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="text-sm text-gray-800 truncate"><%= pagina.titolo %></div>
                        <div class="text-xs text-gray-500">Pag. <%= pagina.numero %></div>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Sezione Strumenti -->
    <div class="border-t border-gray-200 mt-4 pt-4">
      <div class="px-4 mb-2">
        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Strumenti</h3>
      </div>
      <div class="space-y-1">
        <%= link_to strumenti_addizioni_path,
                    data: { turbo_frame: "_top" },
                    class: "flex items-center gap-2 p-3 rounded-lg hover:bg-green-50 transition group" do %>
          <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          <span class="text-sm font-medium text-gray-700">Addizioni in colonna</span>
        <% end %>

        <%= link_to strumenti_sottrazioni_path,
                    data: { turbo_frame: "_top" },
                    class: "flex items-center gap-2 p-3 rounded-lg hover:bg-cyan-50 transition group" do %>
          <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
          </svg>
          <span class="text-sm font-medium text-gray-700">Sottrazioni in colonna</span>
        <% end %>

        <%= link_to strumenti_le_rime_path,
                    data: { turbo_frame: "_top" },
                    class: "flex items-center gap-2 p-3 rounded-lg hover:bg-purple-50 transition group" do %>
          <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <span class="text-sm font-medium text-gray-700">Le rime</span>
        <% end %>
      </div>
    </div>
  </nav>

  <style>
    .sidebar-children.open {
      display: block !important;
      max-height: 2000px !important;
    }
  </style>
</aside>
