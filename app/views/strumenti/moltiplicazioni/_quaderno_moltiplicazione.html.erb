<%#
  Partial per moltiplicazione in colonna con stile quaderno a quadretti
  Supporta moltiplicatori a più cifre con prodotti parziali
  La virgola è renderizzata TRA i quadretti, non in una colonna separata

  Parametri:
    - moltiplicazione: oggetto Moltiplicazione con moltiplicando e moltiplicatore
    - operation_title: (opzionale) titolo da mostrare sopra l'operazione
    - title: (opzionale) titolo alternativo
    - operation_id: (opzionale) ID per i campi del form
%>

<div class="inline-block" data-controller="quaderno-multiplication">

  <% if defined?(operation_title) && operation_title.present? %>
    <div class="font-mono font-bold mb-4 text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded inline-block"><%= operation_title %></div>
  <% elsif defined?(title) && title.present? %>
    <div class="font-mono font-bold mb-4 text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded inline-block"><%= title %></div>
  <% end %>

  <%
    # Numero di colonne per i dati (tutte cifre, senza colonna virgola separata)
    data_cols = moltiplicazione.max_digits
    total_cols = data_cols + 3
    cell_size = "2.5em"
    carry_height = "1.5em"
    has_partials = moltiplicazione.multiplier_length > 1
    has_decimals = moltiplicazione.has_decimals?
    decimal_places = moltiplicazione.decimal_places
    multiplicand_decimals = moltiplicazione.multiplicand_decimals
    multiplier_decimals = moltiplicazione.multiplier_decimals
  %>

  <div class="inline-grid border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900"
       style="grid-template-columns: repeat(<%= total_cols %>, <%= cell_size %>);">

    <!-- Riga etichette -->
    <% if moltiplicazione.show_labels %>
      <% labels = moltiplicazione.quaderno_labels %>
      <% label_colors = moltiplicazione.quaderno_label_colors %>
      <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
      <% data_cols.times do |idx| %>
        <div class="border-r border-b border-gray-300 dark:border-gray-600 flex items-center justify-center <%= label_colors[idx] %>" style="height: <%= cell_size %>;"><%= labels[idx] %></div>
      <% end %>
      <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
      <div class="border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
    <% else %>
      <% total_cols.times do |i| %>
        <div class="<%= i < total_cols - 1 ? 'border-r' : '' %> border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
      <% end %>
    <% end %>

    <% unless has_partials %>
      <!-- Riga riporti (solo per moltiplicatore a 1 cifra) -->
      <% carries = moltiplicazione.result_carries %>
      <% carry_idx_offset = moltiplicazione.max_digits - carries.length %>
      <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= carry_height %>;"></div>
      <% data_cols.times do |digit_idx| %>
        <% carry_data_idx = digit_idx - carry_idx_offset %>
        <% carry_value = carry_data_idx >= 0 ? carries[carry_data_idx] : nil %>
        <% is_last = digit_idx == moltiplicazione.max_digits - 1 %>
        <div class="border-r border-b border-gray-300 dark:border-gray-600 <%= is_last ? '' : 'bg-green-50 dark:bg-green-900/30' %>" style="height: <%= carry_height %>;">
          <input type="text" class="quaderno-input-small bg-transparent focus:bg-green-100/20 dark:focus:bg-green-500/20 text-green-600 dark:text-green-400"
                 data-quaderno-multiplication-target="carry" <% unless is_last %>data-correct-answer="<%= carry_value.to_s %>"<% end %> maxlength="1"
                 <% if moltiplicazione.show_solution && carry_value.present? %>value="<%= carry_value %>"<% end %>
                 <% if is_last %>disabled<% end %>>
        </div>
      <% end %>
      <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= carry_height %>;"></div>
      <div class="border-b border-gray-300 dark:border-gray-600" style="height: <%= carry_height %>;"></div>
    <% end %>

    <!-- Riga moltiplicando -->
    <% multiplicand_digits = moltiplicazione.quaderno_multiplicand_digits %>
    <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
    <% multiplicand_digits.each_with_index do |digit, idx| %>
      <%# Posizione da destra per calcolare dove mettere la virgola %>
      <% pos_from_right = data_cols - 1 - idx %>
      <% show_comma = multiplicand_decimals > 0 && pos_from_right == multiplicand_decimals %>
      <div class="border-r border-b border-gray-300 dark:border-gray-600 relative" style="height: <%= cell_size %>;">
        <input type="text" class="quaderno-input bg-transparent focus:bg-green-100/20 dark:focus:bg-green-500/20 text-gray-800 dark:text-gray-100"
               data-quaderno-multiplication-target="multiplicand" data-correct-answer="<%= digit %>" maxlength="1"
               <% if moltiplicazione.show_multiplicand_multiplier && digit.present? %>value="<%= digit %>"<% end %>>
        <% if show_comma && moltiplicazione.show_multiplicand_multiplier %>
          <span class="quaderno-comma text-gray-800 dark:text-gray-100">,</span>
        <% end %>
      </div>
    <% end %>
    <div class="border-r border-b border-gray-300 dark:border-gray-600 flex items-center justify-center text-green-600 dark:text-green-400 font-bold" style="height: <%= cell_size %>;">×</div>
    <div class="border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>

    <!-- Riga moltiplicatore -->
    <% multiplier_digits = moltiplicazione.quaderno_multiplier_digits %>
    <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
    <% multiplier_digits.each_with_index do |digit, idx| %>
      <% pos_from_right = data_cols - 1 - idx %>
      <% show_comma = multiplier_decimals > 0 && pos_from_right == multiplier_decimals %>
      <div class="border-r border-b border-gray-300 dark:border-gray-600 relative" style="height: <%= cell_size %>;">
        <input type="text" class="quaderno-input bg-transparent focus:bg-green-100/20 dark:focus:bg-green-500/20 text-gray-800 dark:text-gray-100"
               data-quaderno-multiplication-target="multiplier" data-correct-answer="<%= digit %>" maxlength="1" inputmode="numeric"
               <% if moltiplicazione.show_multiplicand_multiplier && digit.present? %>value="<%= digit %>"<% end %>>
        <% if show_comma && moltiplicazione.show_multiplicand_multiplier %>
          <span class="quaderno-comma text-gray-800 dark:text-gray-100">,</span>
        <% end %>
      </div>
    <% end %>
    <div class="border-r border-b border-gray-300 dark:border-gray-600 flex items-center justify-center text-green-600 dark:text-green-400 font-bold" style="height: <%= cell_size %>;"><%= has_partials ? '' : '=' %></div>
    <div class="border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>

    <% if has_partials %>
      <!-- Prodotti parziali con riporti -->
      <% moltiplicazione.quaderno_partial_products.each_with_index do |partial, p_idx| %>
        <%
          # I riporti sono per le colonne delle cifre (non per gli zeri a destra)
          # partial[:carries] ha lunghezza = numero cifre del prodotto parziale - 1
          # Dobbiamo allineare i riporti sotto le cifre corrispondenti
          zeros = partial[:zeros]
          carries = partial[:carries]
          # Numero di colonne per i dati di questo prodotto (esclusi zeri)
          cols_with_data = data_cols - zeros
        %>

        <% first_partial_top_border = p_idx == 0 ? 'border-t-2 border-t-gray-700 dark:border-t-gray-300' : '' %>

        <% if moltiplicazione.show_partial_carries %>
          <%# Riga riporti per questo prodotto parziale (opzionale) %>
          <%# Prima cella (vuota) - bordo sottile %>
          <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= carry_height %>;"></div>
          <% data_cols.times do |col_idx| %>
            <%
              col_from_right = data_cols - 1 - col_idx
              is_zero_column = col_from_right < zeros
              data_col_idx = col_idx
              is_last_data_col = data_col_idx == cols_with_data - 1
              carry_idx = data_col_idx
              carry_value = (carries && carry_idx < carries.length) ? carries[carry_idx] : nil
            %>
            <% if is_zero_column %>
              <div class="border-r border-b border-gray-300 dark:border-gray-600 <%= first_partial_top_border %>" style="height: <%= carry_height %>;"></div>
            <% elsif is_last_data_col %>
              <div class="border-r border-b border-gray-300 dark:border-gray-600 <%= first_partial_top_border %>" style="height: <%= carry_height %>;"></div>
            <% else %>
              <div class="border-r border-b border-gray-300 dark:border-gray-600 bg-orange-50 dark:bg-orange-900/30 <%= first_partial_top_border %>" style="height: <%= carry_height %>;">
                <input type="text" class="quaderno-input-small bg-transparent focus:bg-orange-100/20 dark:focus:bg-orange-500/20 text-orange-600 dark:text-orange-400"
                       data-quaderno-multiplication-target="partialCarry"
                       <% if carry_value.present? %>data-correct-answer="<%= carry_value %>"<% end %>
                       maxlength="1"
                       <% if moltiplicazione.show_partial_products && carry_value.present? %>value="<%= carry_value %>"<% end %>>
              </div>
            <% end %>
          <% end %>
          <%# Penultima cella - bordo spesso, ultima cella - bordo sottile %>
          <div class="border-r border-b border-gray-300 dark:border-gray-600 <%= first_partial_top_border %>" style="height: <%= carry_height %>;"></div>
          <div class="border-b border-gray-300 dark:border-gray-600" style="height: <%= carry_height %>;"></div>

          <%# Riga cifre del prodotto parziale %>
          <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
        <% else %>
          <%# Riga cifre del prodotto parziale (prima cella sempre bordo sottile) %>
          <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
        <% end %>
        <%# Bordo spesso sulla riga cifre solo se non ci sono i riporti %>
        <% digit_row_top_border = moltiplicazione.show_partial_carries ? '' : first_partial_top_border %>
        <% data_cols.times do |digit_idx| %>
          <% digit = partial[:digits][digit_idx] %>
          <% col_from_right = data_cols - 1 - digit_idx %>
          <% is_zero_placeholder = col_from_right < partial[:zeros] %>
          <% if is_zero_placeholder %>
            <div class="border-r border-b border-gray-300 dark:border-gray-600 flex items-center justify-center text-gray-400 dark:text-gray-500 <%= digit_row_top_border %>" style="height: <%= cell_size %>;">0</div>
          <% else %>
            <div class="border-r border-b border-gray-300 dark:border-gray-600 <%= digit_row_top_border %>" style="height: <%= cell_size %>;">
              <input type="text" class="quaderno-input bg-transparent focus:bg-green-100/20 dark:focus:bg-green-500/20 text-gray-800 dark:text-gray-100"
                     data-quaderno-multiplication-target="partial" data-correct-answer="<%= digit %>" maxlength="1" inputmode="numeric"
                     <% if moltiplicazione.show_partial_products && digit.present? %>value="<%= digit %>"<% end %>>
            </div>
          <% end %>
        <% end %>
        <!-- Cella segno (= solo sull'ultimo prodotto parziale) -->
        <div class="border-r border-b border-gray-300 dark:border-gray-600 flex items-center justify-center text-green-600 dark:text-green-400 font-bold <%= digit_row_top_border %>" style="height: <%= cell_size %>;"><%= p_idx == moltiplicazione.quaderno_partial_products.length - 1 ? '=' : '' %></div>
        <div class="border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
      <% end %>

      <!-- Riga riporti somma -->
      <% sum_carries = moltiplicazione.quaderno_sum_carries %>
      <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= carry_height %>;"></div>
      <% sum_carries.each_with_index do |carry, carry_idx| %>
        <% is_last = carry_idx == sum_carries.length - 1 %>
        <div class="border-r border-b border-gray-300 dark:border-gray-600 <%= is_last ? '' : 'bg-green-50 dark:bg-green-900/30' %>" style="height: <%= carry_height %>;">
          <input type="text" class="quaderno-input-small bg-transparent focus:bg-green-100/20 dark:focus:bg-green-500/20 text-green-600 dark:text-green-400"
                 data-quaderno-multiplication-target="sumCarry" <% unless is_last %>data-correct-answer="<%= carry.to_s %>"<% end %> maxlength="1"
                 <% if moltiplicazione.show_solution && carry.present? %>value="<%= carry %>"<% end %>
                 <% if is_last %>disabled<% end %>>
        </div>
      <% end %>
      <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= carry_height %>;"></div>
      <div class="border-b border-gray-300 dark:border-gray-600" style="height: <%= carry_height %>;"></div>
    <% end %>

    <!-- Riga risultato -->
    <% result_digits = moltiplicazione.quaderno_result_digits %>
    <div class="border-r border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>
    <% result_digits.each_with_index do |digit, idx| %>
      <% pos_from_right = data_cols - 1 - idx %>
      <% is_correct_comma_position = decimal_places > 0 && pos_from_right == decimal_places %>
      <% can_have_comma_spot = has_decimals && pos_from_right > 0 && pos_from_right < data_cols %>
      <div class="border-r border-b border-gray-300 dark:border-gray-600 border-t-2 border-t-gray-700 dark:border-t-gray-300 bg-gray-50 dark:bg-gray-800 relative" style="height: <%= cell_size %>;">
        <input type="text" class="quaderno-input bg-transparent focus:bg-green-100/20 dark:focus:bg-green-500/20 text-gray-800 dark:text-gray-100"
               data-quaderno-multiplication-target="result" data-correct-answer="<%= digit %>" maxlength="1" inputmode="numeric"
               <% if moltiplicazione.show_solution && digit.present? %>value="<%= digit %>"<% end %>>
        <% if can_have_comma_spot %>
          <%# Spot cliccabile per la virgola %>
          <button type="button"
                  class="quaderno-comma-spot"
                  data-quaderno-multiplication-target="commaSpot"
                  data-correct-position="<%= is_correct_comma_position %>"
                  data-position="<%= pos_from_right %>"
                  data-action="click->quaderno-multiplication#toggleComma"
                  title="Clicca per inserire la virgola"></button>
        <% end %>
      </div>
    <% end %>
    <div class="border-r border-b border-gray-300 dark:border-gray-600 border-t-2 border-t-gray-700 dark:border-t-gray-300" style="height: <%= cell_size %>;"></div>
    <div class="border-b border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;"></div>

    <!-- Riga vuota sotto -->
    <% total_cols.times do |i| %>
      <div class="<%= i < total_cols - 1 ? 'border-r border-gray-300 dark:border-gray-600' : '' %>" style="height: <%= cell_size %>;"></div>
    <% end %>

    <!-- Riga toolbar nella griglia -->
    <% if moltiplicazione.show_toolbar %>
      <%
        toolbar_buttons = [
          { action: "clearGrid", color: "bg-gray-400/40 hover:bg-gray-400/70", icon: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16", title: "Cancella" },
          { action: "showNumbers", color: "bg-blue-400/40 hover:bg-blue-400/70", icon: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z", title: "Mostra Numeri" },
          { action: "showResult", color: "bg-green-400/40 hover:bg-green-400/70", icon: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z", title: "Mostra Risultato" },
          { action: "verifyAnswers", color: "bg-purple-400/40 hover:bg-purple-400/70", icon: "M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4", title: "Verifica" }
        ]
      %>
      <% total_cols.times do |i| %>
        <div class="<%= i < total_cols - 1 ? 'border-r border-gray-300 dark:border-gray-600' : '' %> border-t border-gray-300 dark:border-gray-600" style="height: <%= cell_size %>;">
          <% if i < toolbar_buttons.length %>
            <% btn = toolbar_buttons[i] %>
            <div class="w-full h-full flex items-center justify-center">
              <button type="button"
                      data-action="click->quaderno-multiplication#<%= btn[:action] %>"
                      class="w-9 h-9 rounded-full flex items-center justify-center <%= btn[:color] %> text-white/80 hover:text-white transition-all print-hidden"
                      title="<%= btn[:title] %>">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="<%= btn[:icon] %>" />
                </svg>
              </button>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
