<style>
  /* Rendi le celle quadrate */
  [data-column-addition-target="input"],
  [data-column-addition-target="result"] {
    width: 4rem;
    height: 4rem;
  }

  /* Celle per i riporti (cambi) - più piccole */
  [data-column-addition-target="carry"] {
    width: 4rem;
    height: 2rem;
  }

  /* Placeholder più piccolo */
  [data-column-addition-target="input"]::placeholder,
  [data-column-addition-target="result"]::placeholder {
    font-size: 0.75rem;
    opacity: 0.3;
  }
</style>

<div class="text-center" data-controller="column-addition">
  
  <% if defined?(operation_title) && operation_title.present? %>
    <div class="text-xl font-mono font-bold mb-4 text-gray-700 bg-gray-100 px-4 py-2 rounded inline-block"><%= operation_title %></div>
  <% elsif defined?(title) && title.present? %>
    <div class="text-xl font-mono font-bold mb-4 text-gray-700 bg-gray-100 px-4 py-2 rounded inline-block"><%= title %></div>
  <% elsif addizione.title.present? %>
    <div class="text-xl font-mono font-bold mb-4 text-gray-700 bg-gray-100 px-4 py-2 rounded inline-block"><%= addizione.title %></div>
  <% end %>

  <div class="flex items-start justify-center gap-2">
    <div class="inline-block border-4 border-blue-400 rounded-lg bg-white" >

      <!-- Header con le etichette delle colonne -->
      <div class="border-b-2 border-gray-300" style="<%= addizione.grid_style %>">
        <% addizione.column_labels.each_with_index do |label, idx| %>
          <div class="text-center <%= addizione.column_colors[idx] %> font-bold <%= 'border-r-2 border-gray-300' unless idx == addizione.column_labels.length - 1 %> py-2 text-sm">
            <%= label %>
          </div>
        <% end %>
      </div>

      <!-- Riga dei riporti (cambi) -->
      <% if addizione.show_carry %>
      <div class="border-b border-gray-200" style="<%= addizione.grid_style %>">
        <% addizione.carries.each_with_index do |carry, idx| %>
          <input type="text"
                 class="text-center text-sm font-bold <%= addizione.column_colors[idx] %> <%= idx == addizione.max_digits - 1 ? 'bg-white' : 'bg-blue-200' %> <%= 'border-r-2 border-gray-300' unless idx == addizione.max_digits - 1 %>"
                 data-column-addition-target="carry"
                 data-correct-answer="<%= carry %>"
                 maxlength="1"
                 placeholder=""
                 <% if addizione.show_solution && carry.present? %>value="<%= carry %>"<% end %>
                 <% if idx == addizione.max_digits - 1 %>disabled<% end %>
                 style="height: 1.5rem;">
        <% end %>
      </div>
      <% end %>

      <!-- Righe degli addendi -->
      <% addizione.addends_digits.each_with_index do |digits, addend_idx| %>
        <div class="border-b border-gray-200" style="<%= addizione.grid_style %>">
          <% digits.each_with_index do |digit, idx| %>
            <input type="text"
                   class="text-center text-2xl font-bold <%= 'border-r-2 border-gray-300' unless idx == digits.length - 1 %>"
                   data-column-addition-target="input"
                   data-correct-answer="<%= digit %>"
                   maxlength="1"
                   placeholder="."
                   <% if addizione.show_addend?(addend_idx) && digit.present? %>value="<%= digit %>"<% end %>>
          <% end %>
        </div>
      <% end %>

      <!-- Riga del risultato -->
      <div class="border-t-4 border-gray-500">
        <div style="<%= addizione.grid_style %>">
          <% addizione.result_digits.each_with_index do |digit, idx| %>
            <input type="text"
                   <% if defined?(operation_id) %>name="results[<%= operation_id %>][result][<%= idx %>]"<% end %>
                   class="text-center text-2xl font-bold <%= 'border-r-2 border-gray-300' unless idx == addizione.result_digits.length - 1 %>"
                   data-column-addition-target="result"
                   data-correct-answer="<%= digit %>"
                   maxlength="1"
                   placeholder="."
                   <% if addizione.show_solution && digit.present? %>value="<%= digit %>"<% end %>>
          <% end %>
        </div>
      </div>

    </div>

    <!-- Colonna degli operatori -->
    <div class="flex flex-col" style="padding-top: <%= addizione.show_carry ? '74px' : '42px' %>">
      <% addizione.addends.each_with_index do |_, idx| %>
        <div class="text-2xl font-bold text-blue-600 flex items-center justify-center" style="height: 4rem;">
          <%= idx < addizione.addends.length - 1 ? addizione.operator : '=' %>
        </div>
      <% end %>
      <div class="flex items-center justify-center border-t-4 border-transparent" style="height: 4rem;">
        <!-- spazio vuoto per la riga del risultato -->
      </div>
    </div>
  </div>

  <!-- Toolbar con pulsanti -->
  <% if addizione.show_toolbar %>
    <div class="print-hidden flex justify-center gap-4 mt-6">
      <!-- Cancella -->
      <button type="button"
              data-action="click->column-addition#clearGrid"
              class="w-14 h-14 rounded-full bg-gray-500 hover:bg-gray-600 text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-110 flex items-center justify-center"
              title="Cancella">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </button>

      <!-- Mostra Addendi -->
      <button type="button"
              data-action="click->column-addition#showAddends"
              class="w-14 h-14 rounded-full bg-blue-500 hover:bg-blue-600 text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-110 flex items-center justify-center"
              title="Mostra Addendi">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      </button>

      <!-- Mostra Risultato -->
      <button type="button"
              data-action="click->column-addition#showResult"
              class="w-14 h-14 rounded-full bg-green-500 hover:bg-green-600 text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-110 flex items-center justify-center"
              title="Mostra Risultato">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>

      <!-- Verifica -->
      <button type="button"
              data-action="click->column-addition#verifyAnswers"
              class="w-14 h-14 rounded-full bg-purple-500 hover:bg-purple-600 text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-110 flex items-center justify-center"
              title="Verifica">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
        </svg>
      </button>
    </div>
  <% end %>
</div>
